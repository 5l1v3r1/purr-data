<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link id="page_style" rel="stylesheet" type="text/css" href="css/default.css">
    <title>Canvas Dialog</title>
  </head>
  <body class="dialog_body">
    <div class="container noselect">
    <form> 

      <fieldset class="canvas"> 
        <legend data-i18n="canvas.prop.heading.gop"></legend> 

        <table class="pairs">
          <tr class="display-flags prop hidden" data-i18n="[title]canvas.prop.gop_tt">
            <td>
              <input type="checkbox" name="gop" value="on">
            </td>
            <td>
              <span id="gop_label" data-i18n="canvas.prop.gop"></span>
            </td>
          </tr>
          <tr class="x-pix prop hidden">
            <td>
            </td>
            <td>
              <table>
                <tr>
                  <td> 
                    <label class="gop_opt" data-i18n="[title]canvas.prop.x_pix_tt">
                      <span data-i18n="canvas.prop.x_pix"></span>
                    </label>
                  </td>
                  <td data-i18n="[title]canvas.prop.x_pix_tt">
                    <input class="gop_opt" type="text" name="x-pix">
                  </td>
                  <td>
                    <label class="gop_opt" data-i18n="[title]canvas.prop.y_pix_tt">
                      <span data-i18n="canvas.prop.y_pix"></span>
                    </label>
                  </td>
                  <td data-i18n="[title]canvas.prop.y_pix_tt">
                    <input class="gop_opt" type="text" name="y-pix">
                  </td>
                </tr>
                <tr class="x-margin prop hidden">
                  <td>
                    <label class="gop_opt" data-i18n="[title]canvas.prop.x_margin_tt">
                      <span data-i18n="canvas.prop.x_margin"></span>
                    </label>
                  </td>
                  <td data-i18n="[title]canvas.prop.x_margin_tt">
                    <input class="gop_opt" type="text" name="x-margin">
                  </td>
                  <td>
                    <label class="gop_opt" data-i18n="[title]canvas.prop.y_margin_tt">
                      <span data-i18n="canvas.prop.y_margin"></span>
                    </label>
                  </td>
                  <td data-i18n="[title]canvas.prop.y_margin_tt">
                    <input class="gop_opt" type="text" name="y-margin">
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr class="display-flags prop hide-name-row">
            <td>
            </td>
            <td>
              <label class="gop_opt" data-i18n="[title]canvas.prop.hide_name_tt">
                <input class="gop_opt" type="checkbox" name="hide-name" value="on">
                <span data-i18n="canvas.prop.hide_name"></span>
              </label>
            </td>
          </tr>
        </table>
      </fieldset> 

      <fieldset class="canvas"> 
        <legend data-i18n="canvas.prop.heading.data_scaling"></legend> 
<div style="display: inline-block; align: left;">
          <div class="x-scale prop hidden">
            <label class="no_gop_opt" data-i18n="[title]canvas.prop.x_scale_tt">
              <span data-i18n="canvas.prop.x_scale"></span>
              <input class="no_gop_opt" type="text" name="x-scale">
            </label>
            <label class="no_gop_opt" data-i18n="[title]canvas.prop.y_scale_tt">
              <span data-i18n="canvas.prop.y_scale"></span>
              <input class="no_gop_opt" type="text" name="y-scale">
            </label>
          </div>

    <div class="gop-range">
        <div class="y1 prop hidden">
          <label class="gop_opt" data-i18n="[title]canvas.prop.y1_tt">
            <span data-i18n="canvas.prop.y1"></span>
            <br>
          <input class="gop_opt" type="text" name="y1">
          </label>
          <br>
        </div>

        <div class="x1 prop hidden">
          <label class="gop_opt" data-i18n="[title]canvas.prop.x1_tt">
            <span data-i18n="canvas.prop.x1"></span>
            <input class="gop_opt" type="text" name="x1">
          </label>
          <label class="gop_opt" data-i18n="[title]canvas.prop.x2_tt">
            <input class="gop_opt" type="text" name="x2">
            <span data-i18n="canvas.prop.x2"></span>
          </label>
          <br>
       </div>

       <div class="y2">
         <label class="gop_opt" data-i18n="[title]canvas.prop.y2_tt">
           <input class="gop_opt" type="text" name="y2">
           <br>
           <span data-i18n="canvas.prop.y2"></span>
         </label>
       </div>
    </div>
</div>
      </fieldset> 


      <fieldset id="arrays" class="hidden">
        <legend data-i18n="canvas.prop.heading.arrays"></legend> 

        <label class="arrays" data-i18n="[title]canvas.prop.array_name">
          <select id="arrays_select" class="hidden"></select>
        </label>

          <div class="array-name prop">
            <label class="array-name"
                   data-i18n="[title]canvas.prop.array_name_tt">
              <span data-i18n="canvas.prop.array_name"></span>
              <input onchange="attr_change(this);"
                     class="array-name"
                     type="text"
                     name="array_name"
                     id="array_name_input">
            </label>
            <label class="array-size"
                   data-i18n="[title]canvas.prop.array_size_tt">
              <span data-i18n="canvas.prop.array_size"></span>
              <input onchange="attr_change(this);"
                     class="array-size"
                     type="text"
                     name="array_size">
            </label>
            <br/>
            <label class="array-save"
                   data-i18n="[title]canvas.prop.array_save_tt">
              <input onchange="flag_change(this);"
                     type="checkbox"
                     name="array_save"
                     value="on">
              <span data-i18n="canvas.prop.array_save"></span>
            </label>
            <br/>
            <label class="array-jump"
                   data-i18n="[title]canvas.prop.array_jump_tt">
              <input onchange="flag_change(this);"
                     type="checkbox" name="array_jump" value="on">
              <span data-i18n="canvas.prop.array_jump"></span>
            </label>
            <br/>

            <span data-i18n="canvas.prop.array_style"></span>
            <br/>
            <table class="array_style">
              <tr>
                <td>
                  <label class="polygon"
                         data-i18n="[title]canvas.prop.array_polygon_tt">
                    <input class="array-style"
                           type="radio"
                           id="polygon"
                           value="0"
                           name="array_style"
                           onchange="flag_change(this);">
                    <span data-i18n="canvas.prop.array_polygon"></span>
                  </label>
                </td>
                <td>
                  <label class="points"
                         data-i18n="[title]canvas.prop.array_points_tt">
                    <input class="array-style"
                           type="radio"
                           id="points"
                           value="1"
                           name="array_style"
                           onchange="flag_change(this);">
                    <span data-i18n="canvas.prop.array_points"></span>
                  </label>
                </td>
              </tr>
              <tr>
                <td>
                  <label class="bezier-curve"
                         data-i18n="[title]canvas.prop.array_bezier_tt">
                    <input class="array-style"
                           type="radio"
                           id="bezier"
                           value="2"
                           name="array_style"
                           onchange="flag_change(this);">
                    <span data-i18n="canvas.prop.array_bezier"></span>
                  </label>
                </td>
                <td>
                  <label class="bar-graph"
                         data-i18n="[title]canvas.prop.array_bars_tt">
                    <input class="array-style"
                           type="radio"
                           id="bar-graph"
                           value="3"
                           name="array_style"
                           onchange="flag_change(this);">
                    <span data-i18n="canvas.prop.array_bars"></span>
                  </label>
                </td>
              </tr>
            </table>
          </div>

      <div class="array-fill">
        <label data-i18n="[title]canvas.prop.array_fill_tt">
          <input onchange="attr_change(this);"
                 type="color"
                 name="array_fill">
          <span data-i18n="canvas.prop.array_fill"></span>
        </label>
        <br>
      </div>

      <div class="array-outline">
        <label data-i18n="[title]canvas.prop.array_outline_tt">
          <input onchange="attr_change(this);"
                 type="color"
                 name="array_outline">
          <span data-i18n="canvas.prop.array_outline"></span>
        </label>
        <br>
      </div>

      <div class="array_in_existing_graph">
        <label class="array-in-existing-graph"
               data-i18n="[title]canvas.prop.array_in_existing_graph_tt">
          <input onchange="flag2_change(this);"
                 type="checkbox"
                 id="array_in_existing_graph"
                 name="array_in_existing_graph"
                 value="on">
          <span data-i18n="canvas.prop.array_in_existing_graph"></span>
        </label>
      </div>

      <div class="array_delete">
        <label class="array-delete"
               data-i18n="[title]canvas.prop.array_delete_tt">
          <input onchange="array_delete_change(this);"
                 type="checkbox"
                 id="array_delete"
                 name="array_delete"
                 value="on">
          <span data-i18n="canvas.prop.array_delete"></span>
        </label>
      </div>
      </fieldset> 

    <div class="submit_buttons">
      <button type="button" id="ok_button" onClick="ok()" data-i18n="[title]iem.prop.ok_tt">
        <span data-i18n="iem.prop.ok"></span>
      </button>
      <button type="button" id="apply_button" onClick="apply()" data-i18n="[title]iem.prop.apply_tt">
        <span data-i18n="iem.prop.apply"></span>
      </button>
      <button type="button" onClick="cancel()" data-i18n="[title]iem.prop.close_tt">
        <span data-i18n="iem.prop.close"></span>
      </button>
    </div>

  </form> 
  </div>      

  <script>
"use strict";
var gui = require("nw.gui");
var pdgui = require("./pdgui.js");

// For translations
var l = pdgui.get_local_string;

// gui preset
pdgui.skin.apply(window);

var pd_object_callback;

// nested arrays of attributes for each garray
// in this canvas
var pd_garray_attrs;
var new_array_dialog;

function ok() {
    // Put the focus on the "ok" button, to make sure we call the change
    // method for an attribute. For some reason I don't need to do this
    // in the iemgui dialog, but I haven't looked close to figure out why.
    // A lot of this could probably be abstracted out, but I'm not sure of
    // the best way to do that yet.
    document.getElementById("ok_button").focus();
    apply();
    cancel();
}

function toggle_fill_color(value) {
    var fill_color_div =  document.getElementsByClassName("array-fill")[0];
    if (value === 3) {
        fill_color_div.classList.remove("hidden");
    } else {
        fill_color_div.classList.add("hidden");
    }
}

function flag_change(elem) {
    var array_attr, arrays_select, name, value, flag;
    arrays_select = document.getElementById("arrays_select");
    array_attr = pd_garray_attrs[arrays_select.value];
    name = elem.name;
    // get value from radio group, checked from checkboxes
    if (name === "array_style") {
        value = document.querySelector('input[name="array_style"]:checked').value;
        pdgui.post("array style found: " + value);
        // Toggle visibility of the fill color button-- only show for bar
        // graph style (= 3)
        toggle_fill_color(+value);
    } else {
        // "+" for casting boolean to number
        value = +elem.checked;
    }
    //pdgui.post("value is " + value);
    flag = array_attr.array_flags;
    pdgui.post("flag before is " + flag);
    switch (name) {
        case "array_save":
            flag &= ~1;    // clear the save bit
            flag |= value; // set it
            break;
        case "array_style":
            flag &= ~(1 << 2); // clear style bit 2...
            flag &= ~(1 << 1); // ... and style bit 1 ...
            flag += (2 * value); // set them
            break;
        case "array_jump":
            flag &= ~(1 << 4);
            flag += (16 * value);
            break;
    }
    array_attr.array_flags = flag;
    pdgui.post("array is " + array_attr);
}

function flag2_change(elem) {
    var array_attr, arrays_select, name, value, flag;
    arrays_select = document.getElementById("arrays_select");
    array_attr = pd_garray_attrs[arrays_select.value];
    name = elem.name;
    // get value from radio group, checked from checkboxes
    // "+" for casting boolean to number
    value = +elem.checked;
    array_attr[name] = value;
    pdgui.post("array is " + array_attr);
}

function array_delete_change(elem) {
    var arrays_select = document.getElementById("arrays_select"),
        array_attr = pd_garray_attrs[arrays_select.value];
    array_attr.array_delete = elem.checked;
}

function attr_change(elem) {
    var array_index, array_attr, arrays_select, name;
    arrays_select = document.getElementById("arrays_select");
    array_attr = pd_garray_attrs[arrays_select.value];
    name = elem.name;
    array_attr[name] = elem.value;
    if (elem.name === "array-fill") {
        array-fill
    }
    pdgui.post("name is " + elem.name);
    pdgui.post("value is " + elem.value);
}

function array_choose(array_index) {
    var i, name, value, elem, style_index, style_opts,
        array_attr = pd_garray_attrs[array_index];
    for (name in array_attr) {
        if (array_attr.hasOwnProperty(name)) {
            value = array_attr[name];
            switch (name) {
                case "array_gfxstub": break;
                case "array_flags":
                    // save contents
                    elem = document.getElementsByName("array_save")[0];
                    elem.checked = (value & 1) != 0;
                    // jump on click
                    elem = document.getElementsByName("array_jump")[0];
                    elem.checked = (value & 16) != 0;
                    // draw style
                    style_opts = document.getElementsByName("array_style");
                    style_index = (value & 6) >> 1;
                    elem = style_opts[style_index];
                    elem.checked = true;
                      // hide "fill" color if we're a bar graph style (= 3)
                    toggle_fill_color(style_index);
                    break;
                default:
                    // name, size, fill, and outline
                    //pdgui.post("name is " + name);
                    elem = document.getElementsByName(name)[0];
                    elem.value = value;
                    break;
            }
        }
    }
}

var arrays_select = document.getElementById("arrays_select");
arrays_select.addEventListener("change", function(evt) {
    pdgui.post("changing to array index " + evt.target.value);
    array_choose(evt.target.value);
});

var gop_label = document.getElementById("gop_label");
gop_label.addEventListener("click", function() {
    document.getElementsByName("gop")[0].click();
});

var gop_button = document.getElementsByName("gop")[0];
gop_button.addEventListener("click", function(evt) {
    set_gop(this.checked);
});

function update_gop_form(opts, state) {
    var elem, i;
    for(i = 0; i < opts.length; i++) {
        elem = opts[i];
        if (elem.type === "checkbox" ||
            elem.type === "text") {
            elem.disabled = state ? false : true;
        }
        if (state) {
            elem.classList.remove("disabled");
        } else {
            elem.classList.add("disabled");
        }
    }
}

var gop_click_count = 0;

function show_sane_defaults() {
    var w, h, xoff, yoff;
    w = document.getElementsByName("x-pix")[0];
    h = document.getElementsByName("y-pix")[0];
    xoff = document.getElementsByName("x-margin")[0];
    yoff = document.getElementsByName("y-margin")[0];
    if (w.value === "0" && h.value === "0") {
        w.value = 85;
        h.value = 60;
        xoff.value = 100;
        yoff.value = 100;
    }
    gop_click_count++;
}

function show_gop_name_and_args_checkbutton(flag) {
    var row = document.getElementsByClassName("hide-name-row")[0];
    row.style.setProperty("visibility", flag ? "visible" : "hidden");
}

function set_gop(state) {
    var gop_opts, no_gop_opts;
    if (state === true && gop_click_count === 0) {
        show_sane_defaults();
    }
    gop_opts = document.getElementsByClassName("gop_opt");
    no_gop_opts = document.getElementsByClassName("no_gop_opt");
    update_gop_form(gop_opts, state);
    update_gop_form(no_gop_opts, state === false);
    // Hide or show the "hide-name" row
    show_gop_name_and_args_checkbutton(state);
}

function substitute_space(arg) {
    var fake_space = String.fromCharCode(11);
    return arg.split(" ").join(fake_space);
}

function get_input(name) {
    var val = document.getElementsByName(name)[0].value;
    return val;
}

// get a value from the garray attr array
function get_array_value(name, attrs) {
    return attrs[name];
}

// for a new array, slot 4 is:
//   "0" to create the array in a new graph
//   "1" to create the array in existing graph
// for a graph with more than one array in it, slot 4 is:
//   "0" to do nothing
//   "1" to delete the array when the dialog is finished
// The deletion interface is bad, but it is also an obscure
// feature probably not worth improving.
function get_array_slot_4(attrs) {
    if (new_array_dialog) {
        return document.getElementById("array_in_existing_graph").checked ?
            "1" : "0";
    } else if (pd_garray_attrs.length > 1) {
        return attrs.array_delete ? "1" : "0";
    } else {
        return "0";
    }
}

function apply() {
    var i, attrs, gop, hide_name, slot_4;
    // If this is a dialog to create a new array, we
    // skip the canvas dialog callback
    if (!new_array_dialog) {
        // Note: the "+" casts Boolean to Number
        gop = +document.getElementsByName("gop")[0].checked;
        hide_name = +document.getElementsByName("hide-name")[0].checked;

        pdgui.pdsend(pd_object_callback, "donecanvasdialog",
            +get_input("x-scale"),
            +get_input("y-scale"),
            (gop ? gop + 2 * hide_name : 0), // No hide_name bit if gop is off
            +get_input("x1"),
            +get_input("y1"),
            +get_input("x2"),
            +get_input("y2"),
            +get_input("x-pix"),
            +get_input("y-pix"),
            +get_input("x-margin"),
            +get_input("y-margin")
        );
    }

    // Now send the array properties, in a separate
    // message for each array
    for (i = 0; i < pd_garray_attrs.length; i++) {
        attrs = pd_garray_attrs[i];
        name = get_array_value("array_name", attrs);
        if (name.slice(0, 1) === "$") {
            name = "#" + name.slice(1);
        }
        pdgui.pdsend(
            get_array_value("array_gfxstub", attrs),
            "arraydialog",
            name,
            get_array_value("array_size", attrs),
            get_array_value("array_flags", attrs),
            get_array_slot_4(attrs),
            0, // xdraw-- not sure if this is still used
            0, // ydraw-- not sure if this is still used
            get_array_value("array_fill", attrs),
            get_array_value("array_outline", attrs)
        );

    }
}

function cancel() {
    var i, attrs, gfxstub;
    //window.close(true);
    pdgui.pdsend(pd_object_callback, "cancel");
    for (i = 0; i < pd_garray_attrs.length; i++) {
        attrs = pd_garray_attrs[i];
        gfxstub = attrs.array_gfxstub;
        pdgui.pdsend(gfxstub, "cancel");
    }
}

function populate_array_form(objects) {
    var arrays_select = document.getElementById("arrays_select"),
        a_field = document.getElementById("arrays"),
        opt, i;
    a_field.classList.remove("hidden");
    if (objects.length > 1) {
        // show the select element if there's more than one array
        arrays_select.classList.remove("hidden");
    }
    for (i = 0; i < objects.length; i++) {
        opt = document.createElement("option");
        opt.setAttribute("value", i);
        opt.textContent = "Array #" + (i+1);
        arrays_select.appendChild(opt);
    }
    // We're permanently hiding the checkbutton for creating a new array
    // inside an existing graph. It's just a weird interface with very
    // few benefits. However, patches that already have multiple arrays
    // inside a graph will continue to work.  (And if users really want
    // this feature back it's easy to turn it back on.
    if (!new_array_dialog || 1) {  // to re-enable, remove the "|| 1"
        document.getElementsByClassName("array_in_existing_graph")[0]
            .classList.add("hidden");
    }
    // Hide the "delete this array" button if we don't have
    // more than one array
    if (new_array_dialog || objects.length < 2) {
        document.getElementsByClassName("array_delete")[0].classList.add("hidden");
    }
    array_choose(0);
}

// Set up arrays in an object

function init_arrays(attr_objects) {
    if (attr_objects.length) {
        // populate form with first array
        populate_array_form(attr_objects);
        // hide x1 and x2 for garrays-- they
        // automatically get set to the array size
        document.getElementsByName("x1")[0].disabled = true;
        document.getElementsByName("x2")[0].disabled = true;
    }
}

// This gets called from the nw_create_window function in index.html
// It provides us with our window id from the C side.  Once we have it
// we can create the menu and register event callbacks
function register_window_id(gfxstub, attr_objects) {
    pd_object_callback = gfxstub;
    var canvas_fieldsets, i, prop;
    // attr_objects[0]: canvas properties
    // attr_objects[1...n-1]: array properties
    add_events(gfxstub);
    // not sure that we need this for properties windows...
    // pdgui.canvas_map(gfxstub);
    translate_form();
    // If this is a new array dialog we might not have any canvas
    // properties to set. If so, just show the array form elements
    if (attr_objects[0].hasOwnProperty("array_gfxstub")) {
        pd_garray_attrs = attr_objects;
        new_array_dialog = true; // this is a new array dialog
        canvas_fieldsets = document.getElementsByClassName("canvas");
        for (i = 0; i < canvas_fieldsets.length; i++) {
            canvas_fieldsets[i].classList.add("hidden");
        }
        // Hide the "Apply" button, as it doesn't make sense for
        // creating a new array
        document.getElementById("apply_button").style.setProperty("display",
            "none");
    } else {
        pd_garray_attrs = attr_objects.slice(1);
        new_array_dialog = false; // this is a canvas/array props dialog
        populate_form(attr_objects[0]);
    }
        init_arrays(pd_garray_attrs);

    // We don't turn on rendering of the "container" div until
    // We've finished displaying all the spans and populating the
    // labels and form elements.  That makes it snappier, at least
    // on older machines.
    document.getElementsByClassName("container")[0].style.setProperty("display", "inline");
    pdgui.resize_window(pd_object_callback);
}

function tr_text(id) {
    var elem = document.getElementById("iem.prop." + id);
    elem.textContent = l("iem.prop." + id);
}

// Stop-gap translator
function translate_form() {
    var i
    var elements = document.querySelectorAll("[data-i18n]");
    for (i = 0; i < elements.length; i++) {
        var data = elements[i].dataset.i18n;
        if (data.slice(0,7) === "[title]") {
            elements[i].title = l(data.slice(7));
        } else {
            elements[i].textContent = l(data);
        }
    }
}

function populate_form(attr_object) {
    var prop;
    for (prop in attr_object) {
        if (attr_object.hasOwnProperty(prop)) {
            // Unhide the span with the class with the same name as the id
            var prop_group = document.getElementsByClassName(prop)[0];
            if (prop_group !== undefined) {
                prop_group.classList.remove("hidden");
            }
            if (prop === "display-flags") {
                // reminder: "!!" forces Boolean, "+" forces Number type
                var flag = +attr_object[prop];
                document.getElementsByName("gop")[0].checked = !!flag;
                document.getElementsByName("hide-name")[0].checked = !!(flag & 2);
                // set visibility of the "hide-name" checkbox based on
                // the gop flag. This way users don't get the idea that it
                // can be set independently of gop.
                show_gop_name_and_args_checkbutton(!!flag);
                // Set the gop-related parts of the form to be
                // enabled/disabled based on state
                set_gop(!!flag);
            }
            var elem = document.getElementsByName(prop);
            if (elem.length > 0) {
                if(prop.slice(-5) === "color") {
                    var hex_string = Number(attr_object[prop]).toString(16);
                    var color_string = "#" +
                        (hex_string === "0" ? "000000" : hex_string);
                    pdgui.post("color is " + color_string);
                    elem[0].value = color_string;
                } else if (elem[0].type === "checkbox") {
                    // The attr here is a string, so we need to
                    // force it to number, hence the "+" below
                    elem[0].checked = +attr_object[prop];
                } else {
                    elem[0].value = attr_object[prop];
                }
            }
        }
    }
    // Some special cases for hiding options for garray dialogs
    if (pd_garray_attrs.length > 0) {
        // Graph-on-parent toggle
        document.getElementsByClassName("display-flags")[0]
            .classList.add("hidden");
        // Graph-on-parent flag for hiding object name/args
        document.getElementsByClassName("display-flags")[1]
            .classList.add("hidden");
        // GOP-rect margins don't make sense for garrays, so hide them
        document.getElementsByClassName("x-margin")[0]
            .classList.add("hidden");
        // X/Y scaling-- garray is always in a gop so not needed
        document.getElementsByClassName("x-scale")[0]
            .classList.add("hidden");
    }
}

function add_events(name) {
    // closing the Window
    gui.Window.get().on("close", function() {
        // this needs to do whatever the "cancel" button does
        //pdgui.pdsend(name + " menuclose 0");
        //cancel();
        pdgui.remove_dialogwin(pd_object_callback);
        gui.Window.get().close(true);
    });
    pdgui.dialog_bindings(name);
}

  </script>
  </body>
</html>
