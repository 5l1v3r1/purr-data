<!DOCTYPE html>
<html>
  <head>
    <link id="page_style" rel="stylesheet"
          type="text/css" href="css/default.css">
  </head>
  <body class="dialog_body">
    <div class="container">
    <form> 
      <fieldset> 
        <legend data-i18n="iem.prop.heading.size"></legend> 

        <table class="pairs">
          <tr class="size prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.size_tt">
                <span data-i18n="iem.prop.size"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.size_tt">
              <input type="text" name="size"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="selection-size prop hidden">
            <td>
              <label data-i18n="[title]iem.select_size_tt">
                <span data-i18n="iem.prop.select_size"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.select_size_tt">
              <input type="text" name="selection-size"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="number prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.number_tt">
                <span data-i18n="iem.prop.number"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.number_tt">
              <input type="number" name="number"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="nonzero-value prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.nonzero_value_tt">
                <span data-i18n="iem.prop.nonzero_value"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.nonzero_value_tt">
              <input type="text" name="nonzero-value"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="width prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.width_tt"> 
                <span data-i18n="iem.prop.width"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.width_tt">
              <input type="text" name="width"
                     onchange="update_attr(this);">
            </td>
            <td>
              <label data-i18n="[title]iem.prop.height_tt">
                <span data-i18n="iem.prop.height"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.height_tt">
              <input type="text" name="height"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="visible-width prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.visible_width_tt">
                <span data-i18n="iem.prop.visible_width"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.visible_width_tt">
              <input type="text" name="visible-width"
                     onchange="update_attr(this);">
            </td>
            <td>
              <label data-i18n="iem.prop.visible_height">
                <span data-i18n="iem.prop.visible_height"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.visible_height_tt">
              <input type="text" name="visible-height"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="minimum-range prop pair hidden">
            <td>
              <label data-i18n="[title]iem.prop.minimum_tt">
                <span data-i18n="iem.prop.minimum"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.minimum_tt">
              <input type="text" name="minimum-range"
                     onchange="update_attr(this);">
            </td>
            <td>
              <label data-i18n="[title]iem.prop.maximum_tt">
                <span data-i18n="iem.prop.maximum"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.maximum_tt">
              <input type="text" name="maximum-range"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="flash-interrupt prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.flash_interrupt_tt">
                <span data-i18n="iem.prop.flash_interrupt"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.flash_interrupt_tt">
              <input type="text" name="flash-interrupt"
                     onchange="update_attr(this);">
            </td>
            <td>
              <label data-i18n="[title]iem.prop.flash_hold_tt">
                <span data-i18n="iem.prop.flash_hold"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.flash_hold_tt">
              <input type="text" name="flash-hold"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="log-height prop hidden">
            <td></td><td></td>
            <td>
              <label data-i18n="[title]iem.prop.log_height_tt">
                <span data-i18n="iem.prop.log_height"></span>
              </label>
            </td>
            <td>
              <input type="text" name="log-height"
                     onchange="update_attr(this);">
            </td>
          </tr>
        </table>

        <div class="init prop hidden">
          <label data-i18n="[title]iem.prop.init_tt">
            <input type="checkbox" name="init" value="on"
                   onchange="update_attr(this);">
            <span data-i18n="iem.prop.init"></span>
          </label>
          <br>
        </div>

        <div class="vu-scale prop hidden">
          <label data-i18n="[title]iem.prop.vu_scale_tt">
            <span data-i18n="iem.prop.vu_scale"></span>
            <input type="checkbox" name="vu-scale" value="on"
                   onchange="update_attr(this);">
          </label>
          <br>
        </div>

        <div class="log-scaling prop hidden">
          <label data-i18n="[title]iem.prop.log_scale_tt">
            <input type="checkbox" name="log-scaling" value="on"
                   onchange="update_attr(this);">
            <span data-i18n="iem.prop.log_scale"></span>
          </label>
          <br>
        </div>

        <div class="steady-on-click prop hidden">
          <label data-i18n="[title]iem.prop.steady_tt">
            <input type="checkbox" name="steady-on-click" value="on"
                   onchange="update_attr(this);">
            <span data-i18n="iem.prop.steady"></span>
          </label>
          <br>
        </div>
      </fieldset> 

      <fieldset> 
        <legend data-i18n="iem.prop.heading.messages"></legend> 

        <table>
          <tr class="send-symbol prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.send_tt">
                <span data-i18n="iem.prop.send"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.send_tt">
              <input type="text" name="send-symbol"
                     onchange="update_attr(this);">
            </td>
            <td>
          <tr class="receive-symbol prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.receive_tt">
                <span data-i18n="iem.prop.receive"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.receive_tt">
              <input type="text" name="receive-symbol"
                     onchange="update_attr(this);">
            </td>
            <td>
          </tr>
        </table>
      </fieldset> 

      <fieldset> 
        <legend data-i18n="iem.prop.heading.label">wrong stuff</legend> 

        <table class="pairs">
          <tr class="label prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.label_tt">
                <span data-i18n="iem.prop.label"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.label_tt">
              <input type="text" name="label"
                     onchange="update_attr(this);">
            </td>
            <td>
              <label data-i18n="[title]iem.prop.xoffset_tt">
                <span data-i18n="iem.prop.xoffset"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.xoffset_tt">
              <input type="text" name="x-offset"
                     onchange="update_attr(this);">
            </td>
            <td>
              <label data-i18n="[title]iem.prop.yoffset_tt">
                <span data-i18n="iem.prop.yoffset"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.yoffset_tt">
              <input type="text" name="y-offset"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="font-style prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.font_tt">
                <span data-i18n="iem.prop.font"></span>
            </td>
            <td data-i18n="[title]iem.prop.font_tt">
              <select name="font-style"
                      onchange="update_attr(this);">
                <option>DejaVu Sans Mono</option>
                <option>Helvetica</option>
                <option>Times</option>
              </select>
            </td>
            <td colspan="4">
              <label data-i18n="[title]iem.prop.fontsize_tt">
                <span data-i18n="iem.prop.fontsize"></span>
                <input type="text" name="font-size"
                       onchange="update_attr(this);">
              <label>
            </td>
          </tr>
        </table>
      </fieldset> 

      <fieldset> 
      <legend data-i18n="iem.prop.heading.colors"></legend> 

      <div class="background-color prop hidden">
        <label data-i18n="[title]iem.prop.bgcolor_tt">
          <input type="color" name="background-color"
                 onchange="update_attr(this);">
          <span data-i18n="iem.prop.bgcolor"></span>
        </label>
        <br>
      </div>

      <div class="foreground-color prop hidden">
        <label data-i18n="[title]iem.prop.fgcolor_tt">
          <input type="color" name="foreground-color"
                 onchange="update_attr(this);">
          <span data-i18n="iem.prop.fgcolor"></span>
        </label>
        <br>
      </div>

      <div class="label-color prop hidden">
        <label data-i18n="[title]iem.prop.label_color_tt">
          <input type="color" name="label-color"
                 onchange="update_attr(this);">
          <span data-i18n="iem.prop.label_color"></span>
        </label>
        <br>
      </div>
    </fieldset> 

    <div class="prop hidden">
      <input type="hidden" name="minimum-size">
      <input type="hidden" name="range-schedule">
      <input type="hidden" name="hide-frame">
    </div>

    <div class="submit_buttons">
      <button type="button" onClick="ok()" data-i18n="[title]iem.prop.ok_tt">
        <span data-i18n="iem.prop.ok"></span>
      </button>
      <button type="button" onClick="apply()" data-i18n="[title]iem.prop.apply_tt">
        <span data-i18n="iem.prop.apply"></span>
      </button>
      <button type="button" onClick="cancel(true)" data-i18n="[title]iem.prop.cancel_tt">
        <span data-i18n="iem.prop.cancel"></span>
      </button>
    </div>

  </form> 
  </div>      

  <script>
"use strict";
var gui = require("nw.gui");
var pdgui = require("./pdgui.js");

// For translations
var l = pdgui.get_local_string;

// gui preset
pdgui.skin.apply(window);

var pd_object_callback,
    old_attrs = {}, // original state. Used if we cancel the dialog
    new_attrs = {}; // changed state. Used if we apply or click "Ok"

function substitute_space(arg) {
    var fake_space = String.fromCharCode(11);
    return arg.split(" ").join(fake_space);
}

function strip_problem_chars(arg) {
    var problem_chars = [";", ",", "{", "}", "\\"],
        ret = arg,
        i;
    for(i = 0; i < problem_chars.length; i++) {
        ret = ret.split(";").join("");
    }
    return ret;
}

function update_attr(elem) {
    pdgui.post("updating attr " + elem.name);
    if (!new_attrs.hasOwnProperty(elem.name)) {
        pdgui.post("warning: new_attrs[" + elem.name + "] doesn't exist");
    }
    if (elem.type === "checkbox") {
        new_attrs[elem.name] = elem.checked ? 1 : 0;
    } else if (elem.type === "select-one") {
        new_attrs[elem.name] = elem.selectedIndex;
    } else if (elem.type === "color") {
        new_attrs[elem.name] = parseInt(elem.value.slice(1), 16)
    } else {
        new_attrs[elem.name] = elem.value;
    }
}

//Clean up strings to send as symbol arguments to Pd
function pd_symbol_carwash(s) {
    s = !s ? "empty" : s;
    if (s.charAt(0) === "$") {
        s = "#" + s.slice(1);
    }
    s = substitute_space(s);
    s = strip_problem_chars(s);
    return s;
}

function send_params(attrs, create_undo_point) {
    /* Not sure what these are...
        iemgui_clip_dim $id
        iemgui_clip_num $id
        iemgui_sched_rng $id
        iemgui_verify_rng $id
        iemgui_sched_rng $id
        iemgui_clip_fontsize $id
    */

    var send_symbol = attrs["send-symbol"],
        receive_symbol = attrs["receive-symbol"],
        label =  attrs["label"];
    send_symbol = pd_symbol_carwash(send_symbol);
    receive_symbol = pd_symbol_carwash(receive_symbol);
    label = pd_symbol_carwash(label);

    var label_x_offset =  attrs["x-offset"];
    var label_y_offset =  attrs["y-offset"];

    // make sure the offset boxes have a value
    if (!label_x_offset) {
        label_x_offset = 0;
    }
    if (!label_y_offset) {
        label_y_offset = 0;
    }

    var height, width;
    var size = attrs["size"];
    if (size === undefined) {
        size = attrs["selection-size"];
    }

    if (size !== undefined) {
        width = size;
        height = size;
    } else {
        width = attrs["width"];
        height = attrs["height"];
    }

    var slot3 = attrs["minimum-range"];
    var slot4 = attrs["maximum-range"];

    if (slot3 === undefined) {
        slot3 = attrs["flash-interrupt"];
        slot4 = attrs["flash-hold"];
    }

    if (slot3 === undefined) {
        slot3 = attrs["visible-width"];
        slot4 = attrs["visible-height"];
    }

    if (slot3 === undefined) { // toggle
        slot3 = attrs["nonzero-value"];
        if (slot3 === undefined) {
            slot3 = 0;
        }
        slot4 = 0;
    }

    var slot5 = attrs["log-scaling"] ? +attrs["log-scaling"] : 0;
    // Hack to accomodate the vu-scale property, which exists in the same
    // slot as this one
    var log_scaling_div = document.querySelector(".log-scaling");
    var no_log_display = log_scaling_div.classList.contains("hidden");

    if (no_log_display) {
        slot5 = attrs["vu-scale"] ? +attrs["vu-scale"] : 0;
    }

    var init = +attrs["init"];
    if (!init) { init = 0; }

    var slot7 = attrs["log-height"];
    if (slot7 === undefined) {
        slot7 = attrs["number"];
    }
    if (slot7 === undefined) {
        slot7 = 0;
    }

    var font_style = attrs["font-style"];
    //if (font_style !== null) { font_style = 0; }

    var font_size = attrs["font-size"];
    if (font_size === undefined) { font_size = 0; }

    // [vu] doesn't have a foreground color
    var foreground_color = attrs["foreground-color"] ?
        attrs["foreground-color"] : 0;
    var background_color = attrs["background-color"];
    var label_color = attrs["label-color"];

    var slot18 = attrs["steady-on-click"] ? +attrs["steady-on-click"] : 0;

    pdgui.pdsend(pd_object_callback, "dialog",
        width, height,
        slot3, // bng: flash-interrupt
               // slider: min-range
               // toggle: nonzero-value
               // my_canvas: visible_width
        slot4, // bng: flash-hold
               // slider: max-range
               // my_canvas: visible_height
        slot5, // slider: lin/log thingy
               // nbx: lin/log
               // vu: vu-scale
        init,
        slot7, // log-height or vradio/hradio number
        send_symbol, receive_symbol, label,
        label_x_offset, label_y_offset,
        font_style, font_size,
        background_color, foreground_color,
        label_color,
        slot18, // steady on click
        0, // not sure what this is doing here
        create_undo_point ? 1 : 0 // whether we set an undo point
    );
}

function cancel(revert_changes) {
    var dirty = false, attr;
    //window.close(true);
    if (revert_changes) {
        for (attr in old_attrs) {
            if (old_attrs[attr] !== new_attrs[attr]) {
                dirty = true;
            }
        }
        if (dirty) {
            send_params(old_attrs, false);
        }
    }
    pdgui.pdsend(pd_object_callback, "cancel");
}

function apply() {
    send_params(new_attrs, false);
}

function ok() {
    // Steal focus from any active input to make sure it triggers an
    // onchange event
    document.querySelector("button").focus();
    // send the old attrs first so we can set an undo point on them
    send_params(old_attrs, false);
    send_params(new_attrs, true);
    cancel(false);
}

// This gets called from the nw_create_window function in index.html
// It provides us with our window id from the C side.  Once we have it
// we can create the menu and register event callbacks
function register_window_id(gfxstub, attr_object) {
    var attr;
    pd_object_callback = gfxstub;
    old_attrs = attr_object;
    for (attr in old_attrs) {
        if (old_attrs.hasOwnProperty(attr)) {
            new_attrs[attr] = old_attrs[attr];
        }
    }
    console.log("attr object is " + attr_object.toString());
    add_events(gfxstub);
    translate_form();
    populate_form(attr_object);
    // We don't turn on rendering of the "container" div until
    // We've finished displaying all the spans and populating the
    // labels and form elements.  That makes it more efficient and
    // snappier, at least on older machines.
    document.getElementsByClassName("container")[0]
        .style.setProperty("display", "inline");
    pdgui.resize_window(pd_object_callback);
}

function tr_text(id) {
    var elem = document.getElementById("iem.prop." + id);
    elem.textContent = l("iem.prop." + id);
}

// Stop-gap translator
function translate_form() {
    var i
    var elements = document.querySelectorAll("[data-i18n]");
    for (i = 0; i < elements.length; i++) {
        var data = elements[i].dataset.i18n;
        if (data.slice(0,7) === "[title]") {
            elements[i].title = l(data.slice(7));
        } else {
            elements[i].textContent = l(data);
        }
    }
}

function populate_form(attr_object) {
    var attr;
    for(attr in attr_object) {
        // Unhide the span with the class with the same name as the id
        var prop_group = document.getElementsByClassName(attr)[0];
        if (prop_group !== undefined) {
            console.log("the thing here is " + attr);
            prop_group.classList.remove("hidden");
        }
        // iemguis use the string 'empty' for null because of
        // the limitations of Pd's state-saving API.  So we have
        // to filter that one out
        if (attr_object[attr] !== "empty") {
            var elem = document.getElementsByName(attr);
            if (elem.length > 0) {
                if(attr.slice(-5) === "color") {
                    var hex_string = Number(attr_object[attr]).toString(16);
                    var color_string = "#" +
                        (hex_string === "0" ? "000000" : hex_string);
                    //pdgui.post("color is " + color_string);
                    elem[0].value = color_string;
                } else if (elem[0].type === "checkbox") {
                    // The attr here is a string, so we need to
                    // force it to number, hence the "+" below
                    elem[0].checked = +attr_object[attr];
                } else if (elem[0].type === "select-one") {
                    elem[0].selectedIndex = +attr_object[attr];
                } else {
                    elem[0].value = attr_object[attr];
                }
            }
        }
    }
}

function add_events(name) {
    // closing the Window
    gui.Window.get().on("close", function() {
        // this needs to do whatever the "cancel" button does
        //pdgui.pdsend(name, "menuclose 0");
        //cancel();
        pdgui.remove_dialogwin(pd_object_callback);
        gui.Window.get().close(true);
    });
    pdgui.dialog_bindings(name);
}

  </script>
  </body>
</html>
