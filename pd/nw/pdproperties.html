<!DOCTYPE html>
<html>
  <head>
  <link rel="stylesheet" type="text/css" href="pdproperties.css">

<style>body{font-family:Verdana;}
fieldset{font-family:Georgia; background-color:#eeeeee;
		 border-radius:3px; border:2px solid black;
		 margin:5px; padding:8px; }

input[type="text"]{width:3em;}

.prop{display: none;}

</style>



  </head>
  <body>

 <form> 
     <fieldset> 
      <legend>size and behavior</legend> 

      <span class="size prop">
        <label title="size of the iemgui">
          size <input type="text" name="size"></label><br>
      </span>

      <span class="nonzero-value prop">
        <label title="value to output when the toggle shows an 'x'">
          nonzero value <input type="text" name="nonzero-value"></label><br>
      </span>

      <span class="flash-interrupt prop">
        <label title="the amount of time (in milliseconds) that Pd will wait before interrupting the flashing of the button">
          interrupt <input type="text" name="flash-interrupt"></label>
      </span>

      <span class="flash-hold prop">
        <label title="the amount of time (in milliseconds) that Pd will display the flash animation">
          hold <input type="text" name="flash-hold"></label>  <br>
      </span>

      <span class="min-range prop">
        <label title="the lowest number to output. Anything lower will be replaced by this number">
          minimum <input type="text" name="min-range"></label>
        <label title="the largest number to output. Anything higher will be replaced by this number">
          maximum <input type="text" name="max-range"></label>  <br>
      </span>

      <span class="init prop">
        <label title="when checked, this will save the state of the iemgui with the patch, and output a value when the patch is loaded (as if you had an invisible [loadbang] connected to the input).">
          init <input type="checkbox" name="init" value="on" ></label> <br>
      </span>
     </fieldset> 

     <fieldset> 
      <legend>messages</legend> 

      <span class="send-symbol prop">
        <label title="symbol you can use to send wireless messages to other iemguis (or a [receive] object)">
          send-symbol <input type="text" name="send-symbol" ></label> <br>
      </span>

      <span class="receive-symbol prop">
        <label title="symbol you can use to receive wireless messages from other iemguis (or from a [send] object)">
          receive-symbol <input type="text" name="receive-symbol" ></label> <br>
      </span>
     </fieldset> 

     <fieldset> 
      <legend>label</legend> 

      <span class="label prop">
        <label title="a label displayed next to this iemgui">
          label <input type="text" name="label" > <br>
      </span>

      <span class="x-offset prop">
        <label title="horizontal offset (from the top-left corner of the object) for the label">
          x offset <input type="text" name="x-offset" ></label>
        <label title="vertical offset (from the top-left corner of the object) for the label">
          y offset <input type="text" name="y-offset"></label> <br>
      </span>

      <span class="font-style prop">
        <label title="which font to use to display the label">
          font <input type="text" name="font-style"></label>
        <label title="size of the label">size <input type="text" name="font-size"><label> <br>
      </span>
     </fieldset> 

     <fieldset> 
      <legend>colors</legend> 

      <span class="background-color prop">
        <label title="background color for the object">
          background <input type="color" name="background-color"></label> <br>
      </span>

      <span class="foreground-color prop">
        <label title="foreground color for the object">
          foreground <input type="color" name="foreground-color"></label> <br>
      </span>

      <span class="label-color prop">
        <label title="color of the label text">
          label <input type="color" name="label-color"></title> <br>
      </span>
     </fieldset> 

     <span class="prop">
       <input type="hidden" name="minimum-size">
       <input type="hidden" name="range-schedule">
     </span>

     <div style="text-align: center">
      <button type="button" onClick="ok()" title="Apply these settings and close the window">Ok</button>
      <button type="button" onClick="apply()" title="Apply these settings without closing the window">Apply</button>
      <button type="button" onClick="cancel()" title="Close window without applying any changes">Cancel</button>
     </div>

 </form> 
        

  <script>
    'use strict';
    var nw = require('nw.gui'); 
    var pdgui = require('./pdgui.js');

    console.log("my working dire is " + pdgui.get_pwd());

    var pd_object_callback;

    function ok() {
        apply();
        cancel();
    }

    function substitute_space(arg) {
        var fake_space = String.fromCharCode(11);
        return arg.split(' ').join(fake_space);
    }

    function strip_problem_chars(arg) {
        var problem_chars = [';', ',', '{', '}', '\\'];
        var ret = arg;
        for(var i = 0; i < problem_chars.length; i++) {
            ret = ret.split(';').join('');
        }
        return ret;
    }

    function apply() {
        pdgui.gui_post("we're applying shits!");

        /* Not sure what these are...
            iemgui_clip_dim $id
            iemgui_clip_num $id
            iemgui_sched_rng $id
            iemgui_verify_rng $id
            iemgui_sched_rng $id
            iemgui_clip_fontsize $id
        */	

        var send_symbol = document.getElementsByName('send-symbol')[0].value;
        var receive_symbol = document.getElementsByName('receive-symbol')[0].value;
        var label =  document.getElementsByName('label')[0].value;
        if (send_symbol === null || send_symbol === '') { send_symbol = 'empty'; }
        if (receive_symbol === null || receive_symbol === '') { receive_symbol = 'empty'; }
        if (label === null || label === '') { label = 'empty'; }

        console.log("send_symbol is " + send_symbol);

        if (send_symbol.charAt(0) === '$') {
            send_symbol = '#' + send_symbol.slice(1);
        }
        if (receive_symbol.charAt(0) === '$') {
            receive_symbol = '#' + receive_symbol.slice(1);
        }
        if (label.charAt(0) === '$') {
            label = '#' + label.slice(1);
        }

        send_symbol = substitute_space(send_symbol);
        receive_symbol = substitute_space(receive_symbol);
        label = substitute_space(label);

        send_symbol = strip_problem_chars(send_symbol);
        receive_symbol = strip_problem_chars(receive_symbol);
        label = strip_problem_chars(label);

        var label_x_offset =  document.getElementsByName('x-offset')[0].value;
        var label_y_offset =  document.getElementsByName('y-offset')[0].value;

	// make sure the offset boxes have a value
        if (label_x_offset === null) { label_x_offset = 0; }
        if (label_y_offset === null) { label_y_offset = 0; }

        var height, width;
        var size = document.getElementsByName('size')[0].value;
        if (size !== null) {
            height = size;
            width = size;
        }

        var slot3 = document.getElementsByName('min-range')[0].value;
        var slot4 = document.getElementsByName('max-range')[0].value;

        pdgui.gui_post("min-range is " + slot3);

        if (slot3 === '') {
            slot3 = document.getElementsByName('flash-interrupt')[0].value;
            slot4 = document.getElementsByName('flash-hold')[0].value;
         pdgui.gui_post("slot3 is now " + slot3);
        }

        if (slot3 === '') { // toggle
            slot3 = document.getElementsByName('nonzero-value')[0].value;
            slot4 = 0;
        }

        var init = document.getElementsByName('init')[0].value;
        if (init !== null) { init = 0; }

        var font_style = document.getElementsByName('font-style')[0].value;
        if (font_style !== null) { font_style = 0; }

        var font_size = document.getElementsByName('font-size')[0].value;
        if (font_size !== null) { font_size = 0; }

        var foreground_color = parseInt(document.getElementsByName('foreground-color')[0].value.slice(1), 16);
        var background_color = parseInt(document.getElementsByName('background-color')[0].value.slice(1), 16);
        var label_color = parseInt(document.getElementsByName('label-color')[0].value.slice(1), 16);

        pdgui.pdsend([pd_object_callback, 'dialog',
            width, height,
            slot3, // flash-interrupt, min-range, or nonzero-value
            slot4, // flash-hold or max-range
            0, // this should be the lin/log thingy
            init,
            0, // this should be the number for toggle
            send_symbol, receive_symbol, label,
            label_x_offset, label_y_offset,
            font_style, font_size,
            background_color, foreground_color,
            label_color,
            0, // steady on click
            0].join(' '));
/*
	pd [concat $id dialog \
		$::dialog($vid:wdt) $::dialog($vid:hgt) \
		$::dialog($vid:min_rng) $::dialog($vid:max_rng) \
		$::dialog($vid:lin0_log1) $::dialog($vid:loadbang) \
		$::dialog($vid:num) \
		$hhhsnd $hhhrcv $hhhgui_nam \
		$::dialog($vid:gn_dx) $::dialog($vid:gn_dy) \
		$::dialog($vid:gn_f) $::dialog($vid:gn_fs) \
		$::dialog($vid:bcol) $::dialog($vid:fcol) \
		$::dialog($vid:lcol) \
		$::dialog($vid:steady) $::dialog($vid:hide) \;]
*/

    }

    function cancel() {
        pdgui.gui_post("closing the window at this point");
//        window.close(true);
        pdgui.pdsend(pd_object_callback + " cancel");
    }

    // This gets called from the nw_create_window function in index.html
    // It provides us with our window id from the C side.  Once we have it
    // we can create the menu and register event callbacks
    function register_canvas_id(gfxstub, attr_array) {
        pd_object_callback = gfxstub;

        console.log('attr array is ' + attr_array.toString());
        for (var i = 0; i < attr_array.length; i+=2) {
            console.log(attr_array[i] + ": " + attr_array[i+1]);
        }
        add_events(gfxstub);
        // not sure that we need this for properties windows
//        pdgui.canvas_map(gfxstub);
        populate_form(attr_array);
//        document.getElementsByClass("fumbles")[0].setAttribute('style', 'display: inline;');
    }

function populate_form(attr_array) {
    for(var i = 0; i < attr_array.length; i+=2) {
        // Unhide the span with the class with the same name as the id
        var prop_group = document.getElementsByClassName(attr_array[i])[0];
        if (prop_group !== undefined) {
            console.log("the thing here is " + attr_array[i]);
            prop_group.style.setProperty('display', 'inline');
        } else {
            pdgui.gui_post("Error: couldn't find iemgui prop group for " + attr_array[i]);
        }
        // iemguis use the string 'empty' for null because of
        // the limitations of Pd's state-saving API.  So we have
        // to filter that one out
        if(attr_array[i+1] !== 'empty') {
            var elem = document.getElementsByName(attr_array[i]);
            if (elem.length > 0) {
                if(attr_array[i].slice(-5) === 'color') {
                    var hex_string = Number(attr_array[i+1]).toString(16);
                    var color_string = "#" + (hex_string === '0' ? '000000' : hex_string);
                    pdgui.gui_post("color is " + color_string);
                    elem[0].value = color_string;
                } else {
                    elem[0].value = attr_array[i+1];
                }
            }
        }
    }
}

function add_events(name) {
    // let's handle some events for this window...

    // closing the Window
    nw.Window.get().on("close", function() {
        // this needs to do whatever the "cancel" button does
//        pdgui.pdsend(name + " menuclose 0");
//        cancel();
        pdgui.remove_dialogwin(pd_object_callback);
        this.close(true);
    });

}

  </script>
  </body>
</html>
