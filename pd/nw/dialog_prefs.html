<!DOCTYPE html>
<html id="prefs_html_element">
  <head>
    <link id="page_style" rel="stylesheet" type="text/css" href="css/default.css">
  </head>
  <body class="dialog_body prefs_body">
    <div class="container noselect prefs_container">
      <div class="prefs_tab_group">
        <input type="radio"
               name="prefs_radio_group"
               id="audio_tab_radio"
               class="tab1 prefs_tab"
               checked="checked" />
        <label for="audio_tab_radio" data-i18n="[title]prefs.heading.audio_tt">
          <span data-i18n="prefs.heading.audio"></span>
        </label>

        <input type="radio"
               name="prefs_radio_group"
               id="midi_tab_radio"
               class="tab2 prefs_tab"/>
        <label for="midi_tab_radio" data-i18n="[title]prefs.heading.midi_tt">
          <span data-i18n="prefs.heading.midi"></span>
        </label>

        <input type="radio"
               name="prefs_radio_group"
               id="gui_tab_radio"
               class="tab3 prefs_tab"/>
        <label for="gui_tab_radio" data-i18n="[title]prefs.heading.gui_tt">
          <span data-i18n="prefs.heading.gui"></span>
        </label>

        <div class="tab1">
          <div class="tab_settings">
            <label data-i18n="[title]prefs.audio.api_tt">
              <span data-i18n="prefs.audio.api"></span>
              <select id="audio_api" onchange="change_api(this);">
              </select>
            </label>
          </div>
          <div class="tab_settings">
            <label data-i18n="[title]prefs.audio.sr_tt">
              <span data-i18n="prefs.audio.sr"></span>
              <input type="text"
                     id="rate"
                     name="rate"
                     onchange="attr_change(this);">
            </label>
          </div>
          <div class="tab_settings">
            <label data-i18n="[title]prefs.audio.blocksize_tt">
              <span data-i18n="prefs.audio.blocksize"></span>
              <select id="blocksize"
                      onchange="attr_change(this);">
                <option value="64">64</option>
                <option value="128">128</option>
                <option value="256">256</option>
                <option value="512">512</option>
                <option value="1024">1024</option>
                <option value="2048">2048</option>
              </select>
            </label>
            <label data-i18n="[title]prefs.audio.advance_tt">
              <span data-i18n="prefs.audio.advance"></span>
              <input type="text"
                     id="advance"
                     name="advance"
                     onchange="attr_change(this);">
            </label>
          </div>
          <div class="tab_settings">
            <span id="callback_container" class="hidden">
              <label data-i18n="[title]prefs.audio.callback_tt">
                <span data-i18n="prefs.audio.callback"></span>
                <input type="checkbox" id="callback" name="callback">
              </label>
            </span>
            <span id="multi_dev_container" class="hidden">
              <label data-i18n="[title]prefs.audio.callback_tt">
                <span data-i18n="prefs.audio.callback"></span>
                <input type="checkbox" id="multi-dev" name="multi-dev">
              </label>
            </span>
          </div>
          <table class="tab_settings">
            <tr>
              <td data-i18n="[title]prefs.audio.input_title_tt">
                <span data-i18n="prefs.audio.input_title"></span>
              </td>
              <td>
                <span data-i18n="prefs.audio.channels"></span>
              </td>
            </tr>
            <tr>
              <td>
                <select id="in1" onchange="dev_change(this);"></select>
              </td>
              <td>
                <label data-i18n="[title]prefs.audio.channels_tt">
                  <input type="text"
                   id="inchans1"
                   name="inchans1"
                   onchange="dev_change(this);">
                </label>
              </td>
            </tr>
            <tr>
              <td>
                <select id="in2" onchange="dev_change(this);"></select>
              </td>
              <td>
                <label data-i18n="[title]prefs.audio.channels_tt">
                  <input type="text"
                   id="inchans2"
                   name="inchans2"
                   onchange="dev_change(this);">
                </label>
              </td>
            </tr>
            <tr>
              <td>
                <select id="in3" onchange="dev_change(this);"></select>
              </td>
              <td>
                <label data-i18n="[title]prefs.audio.channels_tt">
                  <input type="text"
                   id="inchans3"
                   name="inchans3"
                   onchange="dev_change(this);">
                </label>
              </td>
            </tr>
            <tr>
              <td>
                <select id="in4" onchange="dev_change(this);"></select>
              </td>
              <td>
                <label data-i18n="[title]prefs.audio.channels_tt">
                  <input type="text"
                   id="inchans4"
                   name="inchans4"
                   onchange="dev_change(this);">
                </label>
              </td>
            </tr>
            <tr>
              <td data-i18n="[title]prefs.audio.output_title_tt">
                <span data-i18n="prefs.audio.output_title"></span>
              </td>
              <td>
                <span data-i18n="prefs.audio.channels"></span>
              </td>
            </tr>
            <tr>
              <td>
                <select id="out1" onchange="dev_change(this);"></select>
              </td>
              <td>
                <label data-i18n="[title]prefs.audio.channels_tt">
                  <input type="text"
                   id="outchans1"
                   name="outchans1"
                   onchange="dev_change(this);">
                </label>
              </td>
            </tr>
            <tr>
              <td>
                <select id="out2" onchange="dev_change(this);"></select>
              </td>
              <td>
                <label data-i18n="[title]prefs.audio.channels_tt">
                  <input type="text"
                   id="outchans2"
                   name="outchans2"
                   onchange="dev_change(this);">
                </label>
              </td>
            </tr>
            <tr>
              <td>
                <select id="out3" onchange="dev_change(this);"></select>
              </td>
              <td>
                <label data-i18n="[title]prefs.audio.channels_tt">
                  <input type="text"
                   id="outchans3"
                   name="outchans3"
                   onchange="dev_change(this);">
                </label>
              </td>
            </tr>
            <tr>
              <td>
                <select id="out4" onchange="dev_change(this);"></select>
              </td>
              <td>
                <label data-i18n="[title]prefs.audio.channels_tt">
                  <input type="text"
                   id="outchans4"
                   name="outchans4"
                   onchange="dev_change(this);">
                </label>
              </td>
            </tr>
          </table>
        </div>

        <div class="tab2">
          <div class="tab_settings midi_api_container">
            <label data-i18n="[title]prefs.midi.api_tt">
              <span data-i18n="prefs.midi.api"></span>
              <select id="midi_api" onchange="change_api(this);">
              </select>
            </label>
          </div>
          <div class="tab_settings alsa_midi">
            <label data-i18n="[title]prefs.midi.alsa_in_ports_tt">
              <span data-i18n="prefs.midi.alsa_in_ports"></span>
              <input type="text"
                     id="alsa_in_ports"
                     name="alsa_in_ports"
                     onchange="attr_change(this);">
            </label>
            <label data-i18n="[title]prefs.midi.alsa_out_ports_tt">
              <span data-i18n="prefs.midi.alsa_out_ports"></span>
              <input type="text"
                     id="alsa_out_ports"
                     name="alsa_out_ports"
                     onchange="attr_change(this);">
            </label>
          </div>

          <div class="tab_settings midi_devices">
            <span data-i18n="[title]prefs.midi.input_title_tt">
              <span data-i18n="prefs.midi.input_title"></span>
            </span>
            <br/>
            <select id="midi_in1" onchange="dev_change(this);"></select>
            <br/>
            <select id="midi_in2" onchange="dev_change(this);"></select>
            <br/>
            <select id="midi_in3" onchange="dev_change(this);"></select>
            <br/>
            <select id="midi_in4" onchange="dev_change(this);"></select>
            <br/>

            <span data-i18n="[title]prefs.midi.output_title_tt">
              <span data-i18n="prefs.midi.output_title"></span>
            </span>
            <br/>
            <select id="midi_out1" onchange="dev_change(this);"></select>
            <br/>
            <select id="midi_out2" onchange="dev_change(this);"></select>
            <br/>
            <select id="midi_out3" onchange="dev_change(this);"></select>
            <br/>
            <select id="midi_out4" onchange="dev_change(this);"></select>
            <br/>
          </div>
        </div>

        <div class="tab3">
          <div class="tab_settings">
            <label data-i18n="[title]prefs.gui.presets.gui_preset_tt">
              <span data-i18n="prefs.gui.presets.gui_preset"></span>
            </label>
            <select id="gui_preset" onchange="gui_preset_change(this);">
              <option data-i18n="prefs.gui.presets.default" value="default">
              </option>
              <option data-i18n="prefs.gui.presets.inverted" value="inverted">
              </option>
              <option data-i18n="prefs.gui.presets.vanilla" value="vanilla">
              </option>
              <option data-i18n="prefs.gui.presets.vanilla_inverted" value="vanilla_inverted">
              </option>
              <option data-i18n="prefs.gui.presets.extended" value="extended">
              </option>
              <option data-i18n="prefs.gui.presets.c64" value="c64">
              </option>
              <option data-i18n="prefs.gui.presets.subdued" value="subdued">
              </option>
              <option data-i18n="prefs.gui.presets.strongbad" value="strongbad">
              </option>
            </select>
          </div>
        </div>
      </div>

      <div class="submit_buttons prefs_buttons">
        <button type="button" onClick="ok()" data-i18n="[title]prefs.ok_tt">
          <span data-i18n="prefs.ok"></span>
        </button>
        <button type="button" onClick="apply()" data-i18n="[title]prefs.apply_tt">
        <span data-i18n="prefs.apply"></span>
        </button>
        <button type="button" onClick="cancel()" data-i18n="[title]prefs.close_tt">
        <span data-i18n="prefs.close"></span>
        </button>
      </div>
    </div>
  <script>
"use strict";
var gui = require("nw.gui");
var pdgui = require("./pdgui.js");

// For translations
var l = pdgui.get_local_string;

// Gui presets
pdgui.skin.apply(window);

var pd_object_callback;

var pd_audio_attrs;
var pd_midi_attrs;

function ok() {
    apply();
    cancel();
}

function gui_preset_change(elem) {
    pdgui.skin.set(elem.value);
}

// callbacks for devices and/or their number of channels
function dev_change(elem) {
    var attrs, id, direction, index;
    // the same logic works for both channels and
    // devices-- we use the variable 'type' to
    // choose the parameter acoordingly
    var type, midi;
    id = elem.id;
    midi = id.slice(0, 4) === "midi" ? true : false;
    direction = id.replace("midi_", "").slice(0,2) === "in" ? "in" : "out";
    type = id.indexOf("chans") !== -1 ? "chans" : "devs";
    // This would need to change if there could ever be more than
    // 9 devices
    index = +(id.slice(-1)) - 1;
    attrs = get_attr("pd-" + direction + type,
        midi ?  pd_midi_attrs : pd_audio_attrs);
    attrs[index] = midi ? +elem.value + 1 : elem.value;

    disable_unused_chans("in");
    disable_unused_chans("out");
}

function attr_change(elem) {
    var attr, id;
    attr = pd_audio_attrs;
    id = elem.id;
    attr[attr.indexOf(id) + 1] = elem.value;
    pdgui.post("id is " + elem.id);
    pdgui.post("value is " + elem.value);
}

function get_input(name) {
    var val = document.getElementsByName(name)[0].value;
    return val === 0 ? "0" : val;
}

// get a value from the garray attr array
function get_array_value(name, attrs) {
    return attrs[attrs.indexOf(name) + 1];
}

// If dev is -1, just change it to 0. Not sure if the Pd audio
// backend requires this, but it's how it works currently.
function kludge_dev(type, attrs, index) {
    var dev = get_attr("pd-" + type + "devs", attrs)[index];
    if (dev < 0) { dev = 0; }
    return dev;
}

// If the device is -1 ('None'), make the number of channels negative.
// This is the way Pd's audio backend turns off the device. (It works
// this way so you can remember your number of channels even if
// you turn off the device.)
function kludge_chans(type, attrs, index) {
    var dev = get_attr("pd-" + type + "devs", attrs)[index],
        chans = get_attr("pd-" + type + "chans", attrs)[index];
    if (dev < 0 && chans >= 0) { chans *= -1; }
    return chans;
}

function apply() {
    var attrs = pd_audio_attrs;
    pdgui.post("applying preferences");

    // Audio dialog
    pdgui.pdsend(
        "pd audio-dialog",
        kludge_dev("in", attrs, 0),
        kludge_dev("in", attrs, 1),
        kludge_dev("in", attrs, 2),
        kludge_dev("in", attrs, 3),
        kludge_chans("in", attrs, 0),
        kludge_chans("in", attrs, 1),
        kludge_chans("in", attrs, 2),
        kludge_chans("in", attrs, 3),
        kludge_dev("out", attrs, 0),
        kludge_dev("out", attrs, 1),
        kludge_dev("out", attrs, 2),
        kludge_dev("out", attrs, 3),
        kludge_chans("out", attrs, 0),
        kludge_chans("out", attrs, 1),
        kludge_chans("out", attrs, 2),
        kludge_chans("out", attrs, 3),
        get_attr("rate", attrs),
        get_attr("advance", attrs),
        get_attr("cancallback", attrs),
        get_attr("blocksize", attrs)
    );

    attrs = pd_midi_attrs;
    // Midi dialog
    pdgui.pdsend(
        "pd midi-dialog",
        get_attr("pd-indevs", attrs)[0],
        get_attr("pd-indevs", attrs)[1],
        get_attr("pd-indevs", attrs)[2],
        get_attr("pd-indevs", attrs)[3],
        get_attr("pd-outdevs", attrs)[0],
        get_attr("pd-outdevs", attrs)[1],
        get_attr("pd-outdevs", attrs)[2],
        get_attr("pd-outdevs", attrs)[3],
        0, // midi_alsain
        0  // midi_alsaout
    );
}

function cancel() {
    var i, attrs, gfxstub;
    pdgui.post("closing the window at this point");
    // There seems to be a bug in nwjs 0.13 beta3 that doesn't call the
    // "close" event below. This has the symptom of making it impossible
    // to click the "Ok" button and open the preferences dialog again after
    // that. To see if the bug is gone, try removing the next line and see
    // if you can open the Prefs dialog after clicking "Ok".
    pdgui.remove_dialogwin(pd_object_callback);
    window.close(true);
    //pdgui.pdsend(pd_object_callback, "cancel");
}

function change_api(elem) {
pdgui.post("elem is " + elem);
    var id = elem.getAttribute("id"),
        value = elem.value; // need js object property, DOM Attribute won't work
    if (id === "audio_api") {
        pdgui.pdsend("pd audio-setapi", value);
    } else {
        pdgui.pdsend("pd midi-setapi", value);
    }
}

function get_attr(name, attrs) {
    return attrs[attrs.indexOf(name) + 1];
}

function populate_apis(elem, apis, current_api) {
    pdgui.post("curent api is " + current_api);
    var i, opt, api_select = elem;
    pdgui.post("apis are " + apis);
    for (i = 0; i < apis.length; i += 2) {
        opt = document.createElement("option");
        opt.textContent = apis[i];
        opt.setAttribute("value", apis[i+1]);
        api_select.appendChild(opt);
    }
    api_select.value = current_api;
}

function populate_devs(type, attrs) {
    var devs = get_attr(type === "in" ? "sys-indevs" : "sys-outdevs", attrs);
    var i, j, opt, elem, chan_elem, chans;
    pdgui.post("devs are " + devs);
    pdgui.post("type is " + type + 1);
    chans = get_attr("pd-" + type + "chans", attrs);
    for (i = 0; i < 4; i++) {
        elem = document.getElementById(type + (i+1));
        chan_elem = document.getElementById(type + "chans" + (i+1));
        chan_elem.value = chans[i];
        // if the user changed the API, we need to remove the old devs
        while (elem.firstChild) {
            elem.removeChild(elem.firstChild);
        }
        // make a dummy device named 'None' with value -1
        opt = document.createElement("option");
        opt.value = -1;
        opt.textContent = "None";
        elem.appendChild(opt);
        for (j = 0; j < devs.length; j++) {
            opt = document.createElement("option");
            opt.value = j;
            opt.textContent = devs[j];
            elem.appendChild(opt);
        }
    }
}

function populate_midi_devs(type, attrs) {
    var dev_names = get_attr(type === "in" ?
        "midi-indev-names" : "midi-outdev-names", attrs);
    var i, j, opt, elem;
    pdgui.post("dev names are " + dev_names);
    pdgui.post("type is " + type);
    for (i = 0; i < 4; i++) {
        elem = document.getElementById("midi_" + type + (i+1));
        // if the user changed the API, we need to remove the old devs
        while (elem.firstChild) {
            elem.removeChild(elem.firstChild);
        }
        // make a dummy device named 'None' with value -1
        opt = document.createElement("option");
        opt.value = -1;
        opt.textContent = "None";
        elem.appendChild(opt);
        for (j = 0; j < dev_names.length; j++) {
            opt = document.createElement("option");
            opt.value = j;
            opt.textContent = dev_names[j];
            elem.appendChild(opt);
        }
    }
}

function disable_unused_chans(type) {
    var i, chan_elem;
    for (i = 0; i < 4; i++) {
        chan_elem = document.getElementById(type + "chans" + (i+1));
        if (+document.getElementById(type + (i+1)).value === -1) {
            chan_elem.disabled = true;
        } else {
            chan_elem.disabled = false;
        }
    }
}

function disable_unused_devs(type, canmulti) {
    var i;
    if (+canmulti < 2) {
        for (i = 0; i < 3; i++) {
            document.getElementById(type + (i+2)).disabled = true;
        }
    } else {
        for (i = 0; i < 4; i++) {
            document.getElementById(type + (i+1)).disabled = false;
        }
    }
}

function audio_prefs_callback(attrs) {
    pd_audio_attrs = attrs;
    var api_select = document.getElementById("audio_api");
    var callback, i, j, elem, devs, opt;
    pdgui.post("audio attrs are " + attrs);
    pdgui.post("attrs length " + attrs.length);
    // We can get this callback multiple times while the dialog
    // is open.  This is because an API change requires a query
    // for new properties. So we only populate the api options
    // if they don't already exist
    if (api_select.getElementsByTagName("option").length < 1) {
        populate_apis(
            api_select,
            attrs[attrs.indexOf("audio-apis") + 1],
            attrs[attrs.indexOf("current-api") + 1]);
    }

    document.getElementById("rate").value = get_attr("rate", attrs);
    document.getElementById("blocksize").value = get_attr("blocksize", attrs);
    document.getElementById("advance").value = get_attr("advance", attrs);

    callback = get_attr("cancallback", attrs);
    //show the checkbox if the API allows
    if (callback !== -1) {
        document.getElementById("callback_container")
            .classList.remove("hidden");
        document.getElementById("callback").checked = !!callback;
    }

    populate_devs("in", attrs);
    populate_devs("out", attrs);

    set_devs("in", get_attr("pd-indevs", attrs));
    set_devs("out", get_attr("pd-outdevs", attrs));

    // Set chans after the devs (because they may
    // have the side-effect of setting the dev to 'None')
    set_chans("in", get_attr("pd-inchans", attrs));
    set_chans("out", get_attr("pd-outchans", attrs));

    disable_unused_chans("in");
    disable_unused_chans("out");

    disable_unused_devs("in", get_attr("canmulti", attrs));
    disable_unused_devs("out", get_attr("canmulti", attrs));

    pdgui.resize_window(pd_object_callback);
}

function set_devs(type, devs) {
    var i;
    for (i = 0; i < devs.length; i++) {
        document.getElementById(type + (i+1)).value = devs[i];
    }
}

function set_chans(type, chans_array) {
    var i;
    for (i = 0; i < chans_array.length; i++) {
        document.getElementById(type + "chans" + (i+1)).value = chans_array[i];
        // If no chans, set device to -1 (None)
        if (chans_array[i] < 1) {
            document.getElementById(type + (i+1)).value = -1;
        }
    }
}

function midi_prefs_callback(attrs) {
    pd_midi_attrs = attrs;
    var api_select = document.getElementById("midi_api");
    pdgui.post("midi attrs are " + attrs);
    pdgui.post("attrs length " + attrs.length);

    if (api_select.getElementsByTagName("option").length < 1) {
        populate_apis(
            api_select,
            get_attr("midi-apis", attrs),
            get_attr("current-api", attrs)
        );
    }
    // If we still haven't gotten any apis, just assume that the
    // only option is a generic "system" midi and hide the select widget.
    // This should really be taken care of in Pd-- I don't know why, for
    // example, it doesn't just send "MMIO" on Windows when that's the
    // only API available...
    if (api_select.getElementsByTagName("option").length < 1) {
        document.getElementsByClassName("midi_api_container")[0].
            style.setProperty("display", "none");
    }
    // Hide devs and only show the alsa in/out boxes. In the future
    // we need an additional user friendly alsa interface here-- one that
    // just lets the user pick a single input device and single output
    // device, like LMMS does.
    if (+get_attr("current-api", attrs) === 1) { // ALSA API
        document.getElementsByClassName("midi_devices")[0]
            .style.setProperty("display", "none");
        document.getElementsByClassName("alsa_midi")[0]
            .style.setProperty("display", "inherit");
        // For ALSA, we just set the number of ports we want
        // for input and output. The tcl/tk interface just reused
        // the first of the "indevs" for this value, so (for now)
        // we repeat that mistake here...
        document.getElementById("alsa_in_ports").value =
            +get_attr("pd-indevs", attrs)[0];
        document.getElementById("alsa_out_ports").value =
            +get_attr("pd-outdevs", attrs)[0];
    } else {
        document.getElementsByClassName("midi_devices")[0]
            .style.setProperty("display", "inherit");
        document.getElementsByClassName("alsa_midi")[0]
            .style.setProperty("display", "none");
        populate_midi_devs("in", attrs);
        populate_midi_devs("out", attrs);
    }
    pdgui.resize_window(pd_object_callback);
}


// This gets called from the nw_create_window function in index.html
// It provides us with our window id from the C side.  Once we have it
// we can create the menu and register event callbacks
function register_window_id(gfxstub, attr_arrays) {
    pd_object_callback = gfxstub;
    add_events(gfxstub);
    translate_form();

    // We don't turn on rendering of the "container" div until
    // We've finished displaying all the spans and populating the
    // labels and form elements.  That makes it more efficient and
    // snappier, at least on older machines.  However, we still have
    // to asynchronously request the form values from Pd for audio
    // and MIDI...

    pdgui.pdsend("pd audio-properties"); // request audio pref attrs
    pdgui.pdsend("pd midi-properties");  // request midi pref attrs
    document.getElementsByClassName("container")[0].style.setProperty("display", "inline");
}

function tr_text(id) {
    var elem = document.getElementById("iem.prop." + id);
    elem.textContent = l("iem.prop." + id);
}

// Stop-gap translator
function translate_form() {
    var elements = document.querySelectorAll("[data-i18n]"),
        data,
        i;
    for (i = 0; i < elements.length; i++) {
        data = elements[i].dataset.i18n;
        if (data.slice(0,7) === "[title]") {
            elements[i].title = l(data.slice(7));
        } else {
            elements[i].textContent = l(data);
        }
    }
}

function populate_form(attr_array) {
    // First, let's put the translated text for the form labels:
    var i;
    for(i = 0; i < attr_array.length; i+=2) {
        // Unhide the span with the class with the same name as the id
        var prop_group = document.getElementsByClassName(attr_array[i])[0];
        if (prop_group !== undefined) {
            console.log("the thing here is " + attr_array[i]);
            prop_group.classList.remove("hidden");
        } else {
            pdgui.post("Error: couldn't find iemgui prop group for " + attr_array[i]);
        }

        var elem = document.getElementsByName(attr_array[i]);
        if (elem.length > 0) {
            if (elem[0].type === "checkbox") {
                // The attr here is a string, so we need to
                // force it to number, hence the "+" below
                pdgui.post("found a CHECKED ITEM!!!");
                elem[0].checked = +attr_array[i+1];
            } else {
                elem[0].value = attr_array[i+1];
            }
        }
    }
}

function add_events(name) {
    // let's handle some events for this window...

    // closing the Window
    gui.Window.get().on("close", function() {
        // this needs to do whatever the "cancel" button does
        pdgui.remove_dialogwin(pd_object_callback);
        gui.Window.get().close(true);
    });
    pdgui.dialog_bindings(name);
}

  </script>
  </body>
</html>
