<!DOCTYPE html>
<html>
  <head>
    <link id="page_style" rel="stylesheet" type="text/css" href="css/default.css">
  </head>
  <body>
    <div class="container noselect">
      <div class="menu">
        <span data-i18n="[title]prefs.heading.audio_tt">
          <a onclick="display_pref('audio');"
             data-i18n="prefs.heading.audio">
          </a> 
        </span>
        <span data-i18n="[title]prefs.heading.midi_tt">
          <a onclick="display_pref('midi');"
             data-i18n="prefs.heading.midi"></a> 
        </span>
        <span data-i18n="[title]prefs.heading.gui_tt">
          <a onclick="display_pref('gui');"
             data-i18n="prefs.heading.gui"></a> 
        </span>
      </div>

      <fieldset id="audio">
        <legend data-i18n="prefs.heading.audio"></legend>
        <select id="audio_api" onchange="change_api(this);">
        </select>
        <br/>
        <label data-i18n="[title]prefs.audio.sr_tt">
          <span data-i18n="prefs.audio.sr"></span>
          <input type="text"
                 id="rate"
                 name="rate"
                 onchange="attr_change(this);">
        </label>
        <br/>
        <label data-i18n="[title]prefs.audio.advance_tt">
          <span data-i18n="prefs.audio.advance"></span>
          <input type="text"
                 id="advance"
                 name="advance"
                 onchange="attr_change(this);">
        </label>
        <br/>
        <div id="callback_container" class="hidden">
          <label data-i18n="[title]prefs.audio.callback_tt">
            <span data-i18n="prefs.audio.callback"></span>
            <input type="checkbox" id="callback" name="callback">
          </label>
        </div>

        <select id="blocksize"
                onchange="attr_change(this);">
          <option value="64">64</option>
          <option value="128">128</option>
          <option value="256">256</option>
          <option value="512">512</option>
          <option value="1024">1024</option>
          <option value="2048">2048</option>
        </select>
        <br/>
        <table>
          <tr>
            <td>
              Input Devices
            </td>
            <td>
              <span data-i18n="prefs.audio.channels"></span>
            </td>
          </tr>
          <tr>
            <td>
              <select id="in1" onchange="dev_change(this);"></select>
            </td>
            <td>
              <label data-i18n="[title]prefs.audio.channels_tt">
                <input type="text"
                 id="inchans1"
                 name="inchans1"
                 onchange="dev_change(this);">
              </label>
            </td>
          </tr>
          <tr>
            <td>
              <select id="in2" onchange="dev_change(this);"></select>
            </td>
            <td>
              <label data-i18n="[title]prefs.audio.channels_tt">
                <input type="text"
                 id="inchans2"
                 name="inchans2"
                 onchange="dev_change(this);">
              </label>
            </td>
          </tr>
          <tr>
            <td>
              <select id="in3" onchange="dev_change(this);"></select>
            </td>
            <td>
              <label data-i18n="[title]prefs.audio.channels_tt">
                <input type="text"
                 id="inchans3"
                 name="inchans3"
                 onchange="dev_change(this);">
              </label>
            </td>
          </tr>
          <tr>
            <td>
              <select id="in4" onchange="dev_change(this);"></select>
            </td>
            <td>
              <label data-i18n="[title]prefs.audio.channels_tt">
                <input type="text"
                 id="inchans4"
                 name="inchans4"
                 onchange="dev_change(this);">
              </label>
            </td>
          </tr>
          <tr>
            <td>
              Output Devices
            </td>
            <td>
              <span data-i18n="prefs.audio.channels"></span>
            </td>
          </tr>
          <tr>
            <td>
              <select id="out1" onchange="dev_change(this);"></select>
            </td>
            <td>
              <label data-i18n="[title]prefs.audio.channels_tt">
                <input type="text"
                 id="outchans1"
                 name="outchans1"
                 onchange="dev_change(this);">
              </label>
            </td>
          </tr>
          <tr>
            <td>
              <select id="out2" onchange="dev_change(this);"></select>
            </td>
            <td>
              <label data-i18n="[title]prefs.audio.channels_tt">
                <input type="text"
                 id="outchans2"
                 name="outchans2"
                 onchange="dev_change(this);">
              </label>
            </td>
          </tr>
          <tr>
            <td>
              <select id="out3" onchange="dev_change(this);"></select>
            </td>
            <td>
              <label data-i18n="[title]prefs.audio.channels_tt">
                <input type="text"
                 id="outchans3"
                 name="outchans3"
                 onchange="dev_change(this);">
              </label>
            </td>
          </tr>
          <tr>
            <td>
              <select id="out4" onchange="dev_change(this);"></select>
            </td>
            <td>
              <label data-i18n="[title]prefs.audio.channels_tt">
                <input type="text"
                 id="outchans4"
                 name="outchans4"
                 onchange="dev_change(this);">
              </label>
            </td>
          </tr>
        </table>

      </fieldset>

      <fieldset id="midi">
        <legend data-i18n="prefs.heading.midi"></legend>
        <select id="midi_api" onchange="change_api(this);">
        </select>
        <br/>
        <select id="midi_in1" onchange="dev_change(this);"></select>
        <br/>
        <select id="midi_in2" onchange="dev_change(this);"></select>
        <br/>
        <select id="midi_in3" onchange="dev_change(this);"></select>
        <br/>
        <select id="midi_in4" onchange="dev_change(this);"></select>
        <br/>

        <select id="midi_out1" onchange="dev_change(this);"></select>
        <br/>
        <select id="midi_out2" onchange="dev_change(this);"></select>
        <br/>
        <select id="midi_out3" onchange="dev_change(this);"></select>
        <br/>
        <select id="midi_out4" onchange="dev_change(this);"></select>
        <br/>

      </fieldset>

      <fieldset id="gui">
        <legend data-i18n="prefs.heading.gui"></legend>

          <label data-i18n="[title]prefs.gui.presets.gui_preset_tt">
            <span data-i18n="prefs.gui.presets.gui_preset"></span>
          </label>
          <select id="gui_preset" onchange="gui_preset_change(this);">
            <option data-i18n="prefs.gui.presets.default" value="default">
            </option>
            <option data-i18n="prefs.gui.presets.inverted" value="inverted">
            </option>
            <option data-i18n="prefs.gui.presets.vanilla" value="vanilla">
            </option>
            <option data-i18n="prefs.gui.presets.vanilla_inverted" value="vanilla_inverted">
            </option>
            <option data-i18n="prefs.gui.presets.extended" value="extended">
            </option>
            <option data-i18n="prefs.gui.presets.c64" value="c64">
            </option>
            <option data-i18n="prefs.gui.presets.subdued" value="subdued">
            </option>

          </select>

      </fieldset>


    <div class="submit_buttons">
      <button type="button" onClick="ok()" data-i18n="[title]prefs.ok_tt">
        <span data-i18n="prefs.ok"></span>
      </button>
      <button type="button" onClick="apply()" data-i18n="[title]prefs.apply_tt">
      <span data-i18n="prefs.apply"></span>
      </button>
      <button type="button" onClick="cancel()" data-i18n="[title]prefs.cancel_tt">
      <span data-i18n="prefs.cancel"></span>
      </button>
      </div>

    </div>
  <script>
'use strict';
var nw = require('nw.gui'); 
var pdgui = require('./pdgui.js');

// For translations
var l = pdgui.get_local_string;

// Gui presets
pdgui.skin.apply(this);

var pd_object_callback;

var pd_audio_attrs;
var pd_midi_attrs;

function ok() {
    apply();
    cancel();
}

function display_pref(type) {
    pdgui.gui_post("here i am with " + type);
    var all, i, this_elem;
    all = document.getElementsByTagName('fieldset');
    this_elem = document.getElementById(type);
    for (i = 0; i < all.length; i++) {
        all[i].style.setProperty('display', 'none');
    }
        this_elem.style.setProperty('display', 'inline');
}

function gui_preset_change(elem) {
    pdgui.skin.set(elem.value);
}

// callbacks for devices and/or their number of channels
function dev_change(elem) {
    var attrs, id, direction, index;
    // the same logic works for both channels and
    // devices-- we use the variable 'type' to
    // choose the parameter acoordingly
    var type;
    id = elem.id;
    direction = id.slice(0,2) === 'in' ? 'in' : 'out';
    type = id.indexOf('chans') !== -1 ? 'chans' : 'devs';
    // This would need to change if there could ever be more than
    // 9 devices
    index = +(id.slice(-1)) - 1;
    pdgui.gui_post("direction is " + direction);
    attrs = get_attr('pd-' + direction + type, pd_audio_attrs);
    attrs[index] = elem.value;
    pdgui.gui_post("id is " + elem.id);
    pdgui.gui_post("new chan attrs is " + attrs);
}

function attr_change(elem) {
    var attr, id;
    attr = pd_audio_attrs;
    id = elem.id;
    attr[attr.indexOf(id) + 1] = elem.value;
    pdgui.gui_post("id is " + elem.id);
    pdgui.gui_post("value is " + elem.value);
}

function get_input(name) {
    var val = document.getElementsByName(name)[0].value;
    return val === 0 ? '0' : val;
}

// get a value from the garray attr array
function get_array_value(name, attrs) {
    return attrs[attrs.indexOf(name) + 1];
}

// If dev is -1, just change it to 0. Not sure if the Pd audio
// backend requires this, but it's how it works currently.
function kludge_dev(type, attrs, index) {
    var dev = get_attr('pd-' + type + 'devs', attrs)[index];
    if (dev < 0) { dev = 0; }
    return dev;
}

// If the device is -1 ('None'), make the number of channels negative.
// This is the way Pd's audio back end turns off the device. (It works
// this way so you can remember your number of channels even if
// you turn off the device.)
function kludge_chans(type, attrs, index) {
    var dev = get_attr('pd-' + type + 'devs', attrs)[index],
        chans = get_attr('pd-' + type + 'chans', attrs)[index];
    if (dev < 0 && chans >= 0) { chans *= -1; }
    return chans;
}

function apply() {
    var attrs = pd_audio_attrs;
    pdgui.gui_post("we're applying shits!");

    // Audio dialog
    pdgui.pdsend([
        'pd audio-dialog',
        kludge_dev('in', attrs, 0),
        kludge_dev('in', attrs, 1),
        kludge_dev('in', attrs, 2),
        kludge_dev('in', attrs, 3),
        kludge_chans('in', attrs, 0),
        kludge_chans('in', attrs, 1),
        kludge_chans('in', attrs, 2),
        kludge_chans('in', attrs, 3),
        kludge_dev('out', attrs, 0),
        kludge_dev('out', attrs, 1),
        kludge_dev('out', attrs, 2),
        kludge_dev('out', attrs, 3),
        kludge_chans('out', attrs, 0),
        kludge_chans('out', attrs, 1),
        kludge_chans('out', attrs, 2),
        kludge_chans('out', attrs, 3),
        get_attr('rate', attrs),
        get_attr('advance', attrs),
        get_attr('cancallback', attrs),
        get_attr('blocksize', attrs)
        ].join(' '));

    attrs = pd_midi_attrs;
    // Midi dialog
    pdgui.pdsend([
        'pd midi-dialog',
        get_attr('pd-indevs', attrs)[0],
        get_attr('pd-indevs', attrs)[1],
        get_attr('pd-indevs', attrs)[2],
        get_attr('pd-indevs', attrs)[3],
        get_attr('pd-outdevs', attrs)[0],
        get_attr('pd-outdevs', attrs)[1],
        get_attr('pd-outdevs', attrs)[2],
        get_attr('pd-outdevs', attrs)[3],
        0, // midi_alsain
        0  // midi_alsaout
    ].join(' '));
}

function cancel() {
    var i, attrs, gfxstub;
    pdgui.gui_post("closing the window at this point");
    window.close(true);
    //pdgui.pdsend(pd_object_callback + " cancel");
}

function resize_window() {
    var w = document.body.scrollWidth,
        h = document.body.scrollHeight,
        win = pdgui.get_dialogwin(pd_object_callback);
    win.width = w;
    win.height = h;
pdgui.gui_post("w is " + w + " and h is " + h);
}

function change_api(elem) {
    var id = elem.getAttribute('id'),
        value = elem.getAttribute('value');
    if (id === 'audio_api') {
        pdgui.pdsend("pd audio-setapi " + value);
    } else {
        pdgui.pdsend("pd midi-setapi " + value);
    }
}

function get_attr(name, attrs) {
    return attrs[attrs.indexOf(name) + 1];
}

function populate_apis(elem, apis, current_api) {
    pdgui.gui_post("curent api is " + current_api);
    var i, opt, api_select = elem;
    pdgui.gui_post('apis are ' + apis);
    for (i = 0; i < apis.length; i += 2) {
        opt = document.createElement('option');
        opt.textContent = apis[i];
        opt.setAttribute('value', apis[i+1]);
        api_select.appendChild(opt);
    }
    api_select.value = current_api;
}

function populate_devs(type, attrs) {
    var devs = get_attr(type === 'in' ? 'sys-indevs' : 'sys-outdevs', attrs);
    var i, j, opt, elem, chan_elem, chans;
    pdgui.gui_post("devs are " + devs);
    pdgui.gui_post("type is " + type + 1);
    chans = get_attr('pd-' + type + 'chans', attrs);
    for (i = 0; i < 4; i++) {
        elem = document.getElementById(type + (i+1));
        chan_elem = document.getElementById(type + 'chans' + (i+1));
        chan_elem.value = chans[i];
        // if the user changed the API, we need to remove the old devs
        while (elem.firstChild) {
            elem.removeChild(elem.firstChild);
        }
        // make a dummy device named 'None' with value -1
        opt = document.createElement('option');
        opt.value = -1;
        opt.textContent = 'None';
        elem.appendChild(opt);
        for (j = 0; j < devs.length; j++) {
            opt = document.createElement('option');
            opt.value = j; 
            opt.textContent = devs[j];
            elem.appendChild(opt);
        }
    }
}

function populate_midi_devs(type, attrs) {
    var devs = get_attr(type === 'in' ? 'sys-indevs' : 'sys-outdevs', attrs);
    var i, j, opt, elem, chan_elem, chans;
    pdgui.gui_post("devs are " + devs);
    pdgui.gui_post("type is " + type + 1);
    chans = get_attr('pd-' + type + 'chans', attrs);
    for (i = 0; i < 4; i++) {
        elem = document.getElementById(type + (i+1));
        chan_elem = document.getElementById(type + 'chans' + (i+1));
        chan_elem.value = chans[i];
        // if the user changed the API, we need to remove the old devs
        while (elem.firstChild) {
            elem.removeChild(elem.firstChild);
        }
        // make a dummy device named 'None' with value -1
        opt = document.createElement('option');
        opt.value = -1;
        opt.textContent = 'None';
        elem.appendChild(opt);
        for (j = 0; j < devs.length; j++) {
            opt = document.createElement('option');
            opt.value = j; 
            opt.textContent = devs[j];
            elem.appendChild(opt);
        }
    }
}

function audio_prefs_callback(attrs) {
    pd_audio_attrs = attrs;
    var api_select = document.getElementById('audio_api');
    var callback, i, j, elem, devs, opt;
    pdgui.gui_post("audio attrs are " + attrs);
    pdgui.gui_post("attrs length " + attrs.length);
    // We can get this callback multiple times while the dialog
    // is open.  This is because an API change requires a query
    // for new properties. So we only populate the api options
    // if they don't already exist
    if (api_select.getElementsByTagName('option').length < 1) {
        populate_apis(
            api_select,
            attrs[attrs.indexOf('audio-apis') + 1],
            attrs[attrs.indexOf('current-api') + 1]);
    }

    document.getElementById('rate').value = get_attr('rate', attrs);
    document.getElementById('blocksize').value = get_attr('blocksize', attrs);
    document.getElementById('advance').value = get_attr('advance', attrs);

    var callback = get_attr('cancallback', attrs);
    //show the checkbox if the API allows 
    if (callback !== -1) {
        document.getElementById('callback_container')
            .classList.remove('hidden');
        document.getElementById('callback').checked = !!callback;
    }

    populate_devs('in', attrs);
    populate_devs('out', attrs);

    set_devs('in', get_attr('pd-indevs', attrs));
    set_devs('out', get_attr('pd-outdevs', attrs));

    // Set chans after the devs (because they may
    // have the side-effect of setting the dev to 'None')
    set_chans('in', get_attr('pd-inchans', attrs));
    set_chans('out', get_attr('pd-outchans', attrs));
    resize_window();
}

function set_devs(type, devs) {
    var i;
    for (i = 0; i < devs.length; i++) {
        document.getElementById(type + (i+1)).value = devs[i];
    }
}

function set_chans(type, chans_array) {
    var i;
    for (i = 0; i < chans_array.length; i++) {
        document.getElementById(type + 'chans' + (i+1)).value = chans_array[i];
        // If no chans, set device to -1 (None)
        if (chans_array[i] < 1) {
            document.getElementById(type + (i+1)).value = -1;
        }
    }
}

function midi_prefs_callback(attrs) {
    pd_midi_attrs = attrs;
    var api_select = document.getElementById('midi_api');
    pdgui.gui_post("midi attrs are " + attrs);
    pdgui.gui_post("attrs length " + attrs.length);

    if (api_select.getElementsByTagName('option').length < 1) {
        populate_apis(
            api_select,
            get_attr('midi-apis', attrs),
            get_attr('current-api', attrs)
        );
    }
    resize_window();
}


// This gets called from the nw_create_window function in index.html
// It provides us with our window id from the C side.  Once we have it
// we can create the menu and register event callbacks
function register_canvas_id(gfxstub, attr_arrays) {
    pd_object_callback = gfxstub;
    add_events(gfxstub);
    translate_form();

    // default to audio preference panel
    display_pref('audio');
    // We don't turn on rendering of the "container" div until
    // We've finished displaying all the spans and populating the
    // labels and form elements.  That makes it more efficient and
    // snappier, at least on older machines.  However, we still have
    // to asynchronously request the form values from Pd for audio
    // and MIDI...

    pdgui.pdsend("pd audio-properties"); // request audio pref attrs
    pdgui.pdsend("pd midi-properties");  // request midi pref attrs
    document.getElementsByClassName('container')[0].style.setProperty('display', 'inline');
}

function tr_text(id) {
    var elem = document.getElementById('iem.prop.' + id);
    elem.textContent = l('iem.prop.' + id);
}

// Stop-gap translator
function translate_form() {
    var i
    var elements = document.querySelectorAll('[data-i18n]');
    for (i = 0; i < elements.length; i++) {
        var data = elements[i].dataset.i18n;
        if (data.slice(0,7) === '[title]') {
            elements[i].title = l(data.slice(7));
        } else {
            elements[i].textContent = l(data);
        }
    }
}

function populate_form(attr_array) {
    // First, let's put the translated text for the form labels:

    for(var i = 0; i < attr_array.length; i+=2) {
        // Unhide the span with the class with the same name as the id
        var prop_group = document.getElementsByClassName(attr_array[i])[0];
        if (prop_group !== undefined) {
            console.log("the thing here is " + attr_array[i]);
            prop_group.classList.remove('hidden');
        } else {
            pdgui.gui_post("Error: couldn't find iemgui prop group for " + attr_array[i]);
        }

        var elem = document.getElementsByName(attr_array[i]);
        if (elem.length > 0) {
            if (elem[0].type === 'checkbox') {
                // The attr here is a string, so we need to
                // force it to number, hence the "+" below
                gui_post("found a CHECKED ITEM!!!");
                elem[0].checked = +attr_array[i+1];
            } else {
                elem[0].value = attr_array[i+1];
            }
        }
    }
}

function add_events(name) {
    // let's handle some events for this window...

    // closing the Window
    nw.Window.get().on("close", function() {
        // this needs to do whatever the "cancel" button does
        pdgui.remove_dialogwin(pd_object_callback);
        this.close(true);
    });
    pdgui.dialog_bindings(name);
}

  </script>
  </body>
</html>
