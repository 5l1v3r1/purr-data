<!DOCTYPE html>
<html>
  <head>
    <link id="page_style" rel="stylesheet"
          type="text/css" href="css/default.css">
    <title>Pd Search Engine</title>
    <script type="text/javascript" src="./elasticlunr.js"></script>
    <script type="text/javascript" src="./console_search.js"></script>
    <script>
"use strict";
var pdgui = require("./pdgui.js");
var fs = require("fs");
var path = require("path");
var dive = require("./dive.js"); // small module to recursively search dirs
var l = pdgui.get_local_string;

var index = elasticlunr();

pdgui.skin.apply(window);

index.addField("title");
index.addField("keywords");
index.addField("description");
//index.addField("body");
index.addField("path");
index.setRef("id");
var doc_id = 0;

// Stop-gap translator
function translate_form() {
    var elements = document.querySelectorAll("[data-i18n]"),
        data,
        i;
    for (i = 0; i < elements.length; i++) {
        data = elements[i].dataset.i18n;
        if (data.slice(0,7) === "[title]") {
            elements[i].title = l(data.slice(7));
        } else {
            elements[i].textContent = l(data);
        }
    }
}

function add_doc_to_index(filename, data) {
    var title = path.basename(filename, ".pd"),
        big_line = data.replace("\n", " "),
        keywords,
        desc;
        // We use [\s\S] to match across multiple lines...
        keywords = big_line
            .match(/#X text [0-9]+ [0-9]+ KEYWORDS ([\s\S]*?);/),
        desc = big_line
            .match(/#X text [0-9]+ [0-9]+ DESCRIPTION ([\s\S]*?);/);
        keywords = keywords && keywords.length > 1 ? keywords[1].trim() : null;
        desc = desc && desc.length > 1 ? desc[1].trim() : null;
        if (desc) {
            // format Pd's "comma atoms" as normal commas
            desc = desc.replace(" \\,", ",");
        }
    if (title.slice(-5) === "-help") {
        title = title.slice(0, -5);
    }
    index.addDoc({
        "id": doc_id++,
        "title": title,
        "keywords": keywords,
        "description": desc,
        //"body": big_line,
        "path": filename
    });
}

function read_file(err, filename, stat) {
    if (!err) {
        if (filename.slice(-3) === ".pd") {
            fs.readFile(filename, { encoding: "utf8", flag: "r" },
                function(read_err, data) {
                    if (!read_err) {
                        add_doc_to_index(filename, data);
                    } else {
                        pdgui.post("err: " + read_err);
                    }
                }
            );
        }
    } else {
        pdgui.post("err: " + err);
    }
}

function finish_build() {
    document.getElementById("search_text").disabled = false;
    document.getElementById("results").innerHTML = "";
}

function build_index() {
    var doc_path = path.join(pdgui.get_lib_dir(), "doc");
    pdgui.post("doc path is " + doc_path);
    dive(doc_path, read_file, finish_build);
}

function console_unwrap_tag(console_elem, tag_name) {
    var b = console_elem.getElementsByTagName(tag_name),
        parent_elem;
    while (b.length) {
        parent_elem = b[0].parentNode;
        while(b[0].firstChild) {
            parent_elem.insertBefore(b[0].firstChild, b[0]);
        }
        parent_elem.removeChild(b[0]);
        parent_elem.normalize();
    }
}

function console_find_text(elem, evt, callback) {
    var console_text = document.getElementById("results"),
        wrap_tag = "mark",
        wrapper_count;
    window.setTimeout(function () {
        console_unwrap_tag(console_text, wrap_tag);
        // Check after the event if the value is empty
        if (elem.value === undefined || elem.value === "") {
            // Todo: use class instead of style here
            elem.style.setProperty("background", "white");
        } else {
            window.findAndReplaceDOMText(console_text, {
                //preset: "prose",
                find: elem.value.toLowerCase(),
                wrap: wrap_tag
            });
            // The searchAndReplace API is so bad you can't even know how
            // many matches there were without traversing the DOM and
            // counting the wrappers!
            wrapper_count = console_text.getElementsByTagName(wrap_tag).length;
            // Todo: use class instead of style here...
            if (wrapper_count < 1) {
                elem.style.setProperty("background", "red");
            } else {
                elem.style.setProperty("background", "white");
            }
        }
        if (callback) {
            callback();
        }
    }, 0);
}

// start at top and highlight the first result after a search
function console_find_callback() {
    var highlight_checkbox = document.getElementById("console_find_highlight");
    console_find_highlight_all(highlight_checkbox);
    console_find_traverse.set_index(0);
    console_find_traverse.next();
}

function console_find_keypress(elem, e) {
    console_find_text(elem, e, console_find_callback);
}

function console_find_highlight_all(elem) {
    var matches,
        highlight_tag = "console_find_highlighted",
        state = elem.checked,
        i, len;
    matches = document.getElementById("results")
        .getElementsByClassName(highlight_tag);
    // remember-- matches is a _live_ collection, not an array.
    // If you remove the highlight_tag from an element, it is
    // automatically removed from the collection. I cannot yet
    // see a single benefit to this behavior-- here, it means
    // we must decrement i to keep from skipping over every
    // other element... :(
    for (i = matches.length - 1; i >= 0; i--) {
        matches[i].classList.remove(highlight_tag);
    }
    if (state) {
        matches = document.getElementById("results").getElementsByTagName("mark");
        for (i = 0; i < matches.length; i++) {
            matches[i].classList.add(highlight_tag);
        }
    }
}

var console_find_traverse = (function() {
    var count = 0,
        wrap_tag = "mark";
    return {
        next: function() {
            var i, last, next,
                console_text = document.getElementById("results"),
                elements = console_text.getElementsByTagName(wrap_tag);
            if (elements.length > 0) {
                i = count % elements.length;
                elements[i].classList.add("console_find_current");
                if (elements.length > 1) {
                    last = i === 0 ? elements.length - 1 : i - 1;
                    next = (i + 1) % elements.length;
                    elements[last].classList.remove("console_find_current");
                    elements[next].classList.remove("console_find_current");
                }
                // adjust the scrollbar to make sure the element is visible,
                // but only if necessary.
                // I don't think this is available on all browsers...
                elements[i].scrollIntoViewIfNeeded();
                count++;
            }
        },
        set_index: function(c) {
            count = c;
        }
    }
}());

function console_find_keydown(elem, evt) {
    if (evt.keyCode === 13) {
        console_find_traverse.next();
        evt.stopPropagation();
        evt.preventDefault();
        return false;
    } else if (evt.keyCode === 27) { // escape

    } else if (evt.keyCode === 8 || // backspace or delete
               evt.keyCode === 46) {
        console_find_text(elem, evt, console_find_callback);
    }
}

function find_bar_shortcut(evt) {
    var osx = process.platform === "darwin",
    modifier = osx ? "metaKey" : "ctrlKey";
    return (evt.keyCode === 70 && evt[modifier]) // <ctrl-f>
}

function toggle_find_bar() {
    // this is copied from index.js m.edit.find...
    var find_div = document.getElementById("console_find"),
        find_bar_text = document.getElementById("console_find_text"),
        state = find_div.style.getPropertyValue("display");
    if (state !== "inline") {
        find_div.style.setProperty("display", "inline");
        window.setTimeout(function() {
                find_bar_text.focus();
                find_bar_text.select();
            }, 0);
    } else {
        find_div.style.setProperty("display", "none");
        // Blur focus so that the console_find keypress doesn't
        // receive our shortcut key
        find_div.blur();
    }
}

function add_events() {
    // closing the Window
    nw.Window.get().on("close", function() {
        pdgui.remove_dialogwin("search");
        nw.Window.get().close(true);
    });

    // Find bar
    var find_bar = document.getElementById("console_find_text");
    find_bar.placeholder = "Search in Console";
    find_bar.addEventListener("keydown",
        function(evt) {
            if (find_bar_shortcut(evt)) {
                toggle_find_bar();
                evt.stopPropagation();
            } else {
                evt.stopPropagation();
                return console_find_keydown(this, evt);
            }
        }, false
    );
    find_bar.addEventListener("keypress",
        function(evt) {
            console_find_keypress(this, evt);
        }, false
    );

    // Keydown in the document
    document.body.addEventListener("keydown", function(evt) {
        var input_elem = document.getElementById("search_text");
        if (find_bar_shortcut(evt)) {
            toggle_find_bar();
        } else if (evt.target !== input_elem) {
            input_elem.focus();
        } else {
            // If we want to trigger a search on each keystroke we can do it
            // here.
        }
    });

}

function register_window_id(id, attrs) {
    translate_form();
    add_events();
    document.getElementById("results").textContent = "Building Index...";
    document.getElementById("search_text").disabled = true;
    build_index();
}

function doc_search() {
    var text_elem = document.getElementById("search_text"),
        results_elem = document.getElementById("results"),
        search_text = text_elem.value,
        results,
        doc,
        i,
        header,
        div,
        text_node,
        a;
    results_elem.innerHTML = "";
    text_elem.blur();
    results = index.search(search_text);
    for (i = 0; i < results.length; i++) {
        doc = index.documentStore.getDoc(results[i].ref);
        div = document.createElement("div");
        a = document.createElement("a");
        a.href = "javascript: pdgui.doc_open('" +
                 path.dirname(doc.path) + "', '" +
                 path.basename(doc.path) + "');"
        a.textContent = doc.title;
        header = document.createElement("h3");
        header.appendChild(a);
        text_node = document.createTextNode(doc.description);
        div.appendChild(header);
        div.appendChild(text_node);
        results_elem.appendChild(div);
    }
    if (results.length === 0) {
        results_elem.textContent = "No Results Found.";
    }
}
    </script>
  </head>
  <body>
    <div style="font-family: Courier 10 Pitch; font-size: 2.5em;">
      <span style="color: #c44654;">P</span><span style="color: #ac399c;">u</span><span style="color: #54439c;">r</span><span style="color: #ce4d3d;">e</span><span style="color: #3c9e54;">d</span><span style="color: #7349a4;">a</span><span style="color: purple;">t</span><span style="color: #7349a4;">a</span>
    </div>
    <svg xmlns="http://www.w3.org/2000/svg"
         version="1.1"
         viewBox="0 0 450 65"
         width="225"
         height="32.5">
      <g transform="matrix(1 0 0 1 -33 -87)">
        <path fill="#c44654"
              stroke="#c44654"
              transform="matrix(2,0,0,2,0,0)"
              d="m 30.2775 64.0212 -4.08 0 0 -5.96 3.4 0 c 6.43999 0 9.68 -2.48001 9.68 -7.2 0 -4.72 -3.24001 -7.24 -9.68 -7.24 l -9.04 0 c -0.919999 0 -1.36 0.480001 -1.36 1.4 0 1.32 0.760002 1.4 2.56 1.4 l 1.36 0 0 17.6 -2.52 0 c -0.959999 0 -1.4 0.440001 -1.4 1.36 0 0.919999 0.440001 1.4 1.36 1.4 l 9.56 0 c 1.36 0 1.96 -0.200001 1.96 -1.4 0 -0.959999 -0.560001 -1.36 -1.8 -1.36 m -4.08 -17.6 3.6 0 c 4.08 0 6.16 1.48 6.16 4.52 0 3.04 -2.08 4.56 -6.16 4.56 l -3.6 0 0 -9.08"
        ></path>
      </g>
      <g transform="matrix(1 0 0 1 -564 -82)">
        <path fill="#ac399c"
              stroke="#ac399c"
              transform="matrix(2,0,0,2,0,0)"
              d="m 313.267 59.5812 0 -9.36 c 0 -0.08 0 -0.12 0 -0.2 0 -0.879999 -0.04 -1.28 -1.12 -1.28 l -2.96 0 c -1.04 0 -1.56 0.440001 -1.56 1.36 0 0.999999 0.56 1.4 1.8 1.4 0.28 0 0.6 0 0.88 0 l 0 8.8 c 0 4.56 2.16 6.88 6.44 6.88 2.36 0 4.04 -0.920002 6.08 -2.52 l 0 1.32 c 0 0.48 0.36 0.8 1.12 0.8 l 2.96 0 c 1.04 0 1.56 -0.480001 1.56 -1.4 0 -0.999999 -0.56 -1.36 -1.8 -1.36 -0.28 0 -0.6 0 -0.88 0 l 0 -13.4 c 0 -1.16 0 -1.88 -1.36 -1.88 l -4.16 0 c -1.08 0 -1.56 0.400001 -1.56 1.36 0 0.959999 0.4 1.4 1.44 1.4 l 2.68 0 0 8.08 c 0 2.88 -2.52 4.72 -5.16 4.72 -3.04 0 -4.4 -1.52 -4.4 -4.72"
        ></path>
      </g>
      <g transform="matrix(1 0 0 1 -411 -77)">
        <path fill="#54439c"
              stroke="#54439c"
              transform="matrix(2,0,0,2,0,0)"
              d="m 268.182 64.0212 0 -8.08 c 2.6 -2.96 4.8 -4.52 6.96 -4.52 1.52 0 2.36 1.2 3.4 1.2 0.84 0 1.72 -0.880001 1.72 -1.84 0 -1.44 -1.44 -2.52 -3.88 -2.52 -3.12 0 -5.76 1.52 -8.2 4.6 l 0 -3.32 c 0 -0.559999 -0.36 -0.8 -1.08 -0.8 l -4.44 0 c -1.04 0 -1.56 0.440001 -1.56 1.36 0 0.999999 0.56 1.4 1.84 1.4 0.2 0 0.56 0 1 0 l 1.32 0 0 12.52 -3.44 0 c -1.08 0 -1.64 0.440001 -1.64 1.36 0 0.919999 0.56 1.4 1.6 1.4 l 12.76 0 c 1.16 0 1.6 -0.280001 1.6 -1.4 0 -0.959999 -0.48 -1.36 -1.48 -1.36 l -6.48 0"
        ></path>
      </g>
      <g transform="matrix(1 0 0 1 -605 -78)">
        <path fill="#ce4d3d"
              stroke="#ce4d3d"
              transform="matrix(2,0,0,2,0,0)"
              d="m 383.895 56.0612 c 0.76 -3.24 3.28 -5.16 6.72 -5.16 3.16 0 5.64 2.04 6 5.16 l -12.72 0 m -0.08 2.56 13.12 0 c 2.4 0 3.24 -0.000002 3.24 -1.84 0 -4.36 -3.64001 -8.56 -9.56 -8.56 -6.03999 0 -10.2 3.88001 -10.2 9.48 0 5.83999 3.76001 9.56 9.8 9.56 2.64 0 5.48 -0.640001 8.16 -1.96 1.16 -0.559999 1.72 -1.16 1.72 -1.96 0 -0.719999 -0.6 -1.28 -1.36 -1.28 -1.76 0 -4.28 2.44 -8.24 2.44 -4.04 0 -6.48 -2.12 -6.68 -5.88"
        ></path>
      </g>
      <g transform="matrix(1 0 0 1 -63 -75)">
        <path fill="#3c9e54"
              stroke="#3c9e54"
              transform="matrix(2,0,0,2,0,0)"
              d="m 142.87 58.0213 c 0 -3.88 2.48 -6.44 6.16 -6.44 3.64 0 6.16 2.64 6.16 6.24 0 3.6 -2.6 6.32 -6.2 6.32 -3.48 0 -6.12 -2.44 -6.12 -6.12 m 12.8 8.76 3.72 0 c 0.84 0 1.4 -0.520001 1.4 -1.4 0 -0.999999 -0.56 -1.36 -1.8 -1.36 -0.28 0 -0.6 0 -0.88 0 l 0 -22 c 0 -0.559999 -0.36 -0.8 -1.12 -0.8 l -4 0 c -1.04 0 -1.56 0.480001 -1.56 1.4 0 1.28 0.84 1.4 2.68 1.4 l 1.04 0 0 7.48 c -1.52 -1.88 -3.68 -2.8 -6.36 -2.8 -5.27999 0 -9.28 4.08001 -9.28 9.24 0 5.47999 3.76 9.32 8.68 9.32 2.76 0 5.16 -1.12 6.72 -3.08 l 0 1.6 c 0 0.679999 0.16 1 0.76 1"
        ></path>
      </g>
      <g transform="matrix(1 0 0 1 -49 -78)">
        <path fill="#7349a4"
              stroke="#7349a4"
              transform="matrix(2,0,0,2,0,0)"
              d="m 178.292 64.3012 0.2 1.2 c 0.16 0.839999 0.64 1.28 1.36 1.28 l 3.08 0 c 1.04 0 1.56 -0.480001 1.56 -1.4 0 -1.16 -0.68 -1.36 -2.32 -1.36 l -1 0 0 -8.84 c 0 -4.72 -2.32001 -6.92 -7.32 -6.92 -4.4 0 -7.28 1.4 -7.28 2.76 0 0.999999 0.6 1.64 1.32 1.64 1.52 0 3.12 -1.64 5.88 -1.64 3 0 4.4 1.4 4.4 4.4 0 0.04 0 0.08 0 0.12 -1.6 -0.4 -3.12 -0.6 -4.64 -0.6 -5.79999 0 -9.04 2.44 -9.04 6.48 0 3.44 2.56 5.84 6.48 5.84 2.68 0 5.2 -1.04 7.32 -2.96 m -0.12 -6.16 0 2.12 c 0 1.76 -3.2 4 -6.72 4 -2.28 0 -3.84 -1.32 -3.84 -3.04 0 -2.2 2.28 -3.76 6.44 -3.76 1.44 0 2.8 0.24 4.12 0.68"
        ></path>
      </g>
      <g transform="matrix(1 0 0 1 -93 -80)">
        <path fill="purple"
              stroke="purple"
              transform="matrix(2,0,0,2,0,0)"
              d="m 227.298 49.8213 -7.68 0 0 -3.96 c 0 -1.92 -0.16 -2.72 -1.56 -2.72 -1.04 0 -1.52 0.560001 -1.52 1.64 0 0.519999 0 0.88 0 1.04 l 0 4 -2.16 0 c -1.88 0 -2.68 0.120001 -2.68 1.4 0 0.959999 0.48 1.36 1.56 1.36 l 3.28 0 0 6.52 c 0 0.2 0 0.4 0 0.6 0 1.8 0.04 3.36 0.72 4.52 1.12 1.96 3.2 2.92 6.2 2.92 1.84 0 3.88 -0.520001 6.32 -1.48 1.44 -0.559999 2.16 -1.12 2.16 -2.04 0 -0.719999 -0.64 -1.4 -1.36 -1.4 -1.56 0 -4.16 2.08 -7.32 2.08 -3.44 0 -3.68 -2.08 -3.68 -5.2 l 0 -6.52 7.92 0 c 1.08 0 1.64 -0.440001 1.64 -1.36 0 -0.999999 -0.6 -1.4 -1.84 -1.4"
        ></path>
      </g>
      <g transform="matrix(1 0 0 1 52 -87)">
        <path fill="#7349a4"
              stroke="#7349a4"
              transform="matrix(2,0,0,2,0,0)"
              d="m 178.292 64.3012 0.2 1.2 c 0.16 0.839999 0.64 1.28 1.36 1.28 l 3.08 0 c 1.04 0 1.56 -0.480001 1.56 -1.4 0 -1.16 -0.68 -1.36 -2.32 -1.36 l -1 0 0 -8.84 c 0 -4.72 -2.32001 -6.92 -7.32 -6.92 -4.4 0 -7.28 1.4 -7.28 2.76 0 0.999999 0.6 1.64 1.32 1.64 1.52 0 3.12 -1.64 5.88 -1.64 3 0 4.4 1.4 4.4 4.4 0 0.04 0 0.08 0 0.12 -1.6 -0.4 -3.12 -0.6 -4.64 -0.6 -5.79999 0 -9.04 2.44 -9.04 6.48 0 3.44 2.56 5.84 6.48 5.84 2.68 0 5.2 -1.04 7.32 -2.96 m -0.12 -6.16 0 2.12 c 0 1.76 -3.2 4 -6.72 4 -2.28 0 -3.84 -1.32 -3.84 -3.04 0 -2.2 2.28 -3.76 6.44 -3.76 1.44 0 2.8 0.24 4.12 0.68"
        ></path>
      </g>
    </svg>
    <form id="search_form" action="javascript:doc_search();">
      <input type="search"
             name="search_text"
             id="search_text"
             placeholder="Search Pd Docs">
    </form>
    <div id="results">
    </div>
    <div id = "console_find" style="display:none;">
      <div>
        <label><input type="text"
                      id="console_find_text"
                      name="console_find_text"
                      defaultValue="Search in Console"
                      style="width:10em;"/>
        </label>
        <label>Highlight All
               <input type="checkbox"
                      id="console_find_highlight"
                      name="console_find_highlight"
                      onchange="console_find_highlight_all(this);"/>
        </label>
      </div>
    </div>
  </body>
</html>
